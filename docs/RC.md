# Documento Unificado: Vis√£o Geral, Arquitetura, Desenvolvimento, Fixes, Qualidade e Refatora√ß√µes do Projeto RC Gestor

## Introdu√ß√£o e Vis√£o Geral
Este documento consolida informa√ß√µes chave sobre a arquitetura, features, decis√µes t√©cnicas, qualidade de c√≥digo, evolu√ß√µes, corre√ß√µes, iniciativas de testes e refatora√ß√µes do projeto RC Gestor, um aplicativo desktop em Python com Tkinter para gerenciamento de consultorias farmac√™uticas, integrado ao Supabase para backend. O foco abrange estrutura modular, features como Auditoria, Clientes, Senhas, HUB (notas), Lixeira, PDF Preview, Uploads e Regulations, decis√µes arquiteturais (ex.: timeouts HTTP), iniciativas de qualidade (cobertura de testes ‚â•95%, fixes de seguran√ßa, linting via ruff/pyright/bandit/vulture), corre√ß√µes espec√≠ficas para UX, encoding, integra√ß√µes e performance de logs, al√©m de refatora√ß√µes UI em m√∫ltiplas fases para modularizar l√≥gica test√°vel em m√≥dulos como pdf_preview (fases 01-03), clientes/main_screen (fases 01-07 com √™nfase em batch operations), hub e lixeira, e microfases de cobertura para m√≥dulos como app_core.py, clientes/controllers (event_router.py, connectivity.py, batch_operations.py, column_controls_layout.py, filter_sort_manager.py, connectivity_state_manager.py, ui_state_manager.py, main_screen_actions.py, selection_manager.py, rendering_adapter.py, pick_mode_manager.py), auditoria (archives.py, service.py, controller.py), uploads/service.py e features/regulations/service.py. Inclui an√°lises gerais do projeto (cobertura global 65.2%, com m√≥dulos cr√≠ticos em 95-100%), scripts de an√°lise (ex.: analyze_path_errors.py para erros Path/PathLike, analyze_linters.py para Ruff/Flake8, analyze_pyright_errors.py para erros Pyright, analyze_config_errors.py para config/settings, analyze_pyright_warnings.py para warnings, analyze_supabase_errors.py para Supabase repo/client, analyze_style_issues.py para estilo Ruff/Flake8, analyze_security.py para Bandit em produ√ß√£o, analyze_top_errors.py para top erros Pyright por arquivo/regra, analyze_unknown_errors.py para Unknown types em UI/core, analyze_modules.py para mapa de m√≥dulos, pdf_batch_from_images.py para convers√£o de imagens em PDFs). Baseado em documenta√ß√µes de novembro a dezembro de 2025 (vers√µes at√© v1.4.05, branches como qa/fixpack-04). O projeto enfatiza separa√ß√£o de camadas para escalabilidade, com 183 m√≥dulos Python distribu√≠dos em UI (76), Core (53), Infra (34), Script (11), Adapter (5), Domain (4). Datas chave incluem atualiza√ß√µes em 2025-11-27 a 2025-12-10, com √™nfase em microfases para elevar cobertura, relat√≥rios QA globais (ex.: ruff clean, pyright com 9 erros restantes, pytest com 23 falhas) e refatora√ß√µes UI para extrair fun√ß√µes puras e aumentar testabilidade sem Tkinter, totalizando centenas de testes novos em helpers. An√°lise geral (analise_geral_projeto_v1.4.05.md, 2025-12-09) indica cobertura global 65.2% (24.257 statements, 8.195 missing), pontos fortes em headless (95-100%), fracos em UI (30-50%), recomenda microfases em ondas de 4, priorizando uploads/regulations/app_core/auditoria, meta 6 meses: 75-80% global, refactor UI para headless separation.

Devlogs como devlog-hub-mf31-plus.md registram microfases do Hub a partir da MF-31, focando em decomposi√ß√£o do HubScreen (extra√ß√£o de l√≥gica ass√≠ncrona, helpers), transformando-o em orquestrador puro, com valida√ß√µes (ex.: MF-31 para _update_notes_section, MF-32 para _update_tasks_section, MF-33 para _update_obrigacoes_section, MF-34 para _update_obrigacoes_section, MF-35 para _update_notes_section, MF-36 para _update_tasks_section, MF-37 para _update_obrigacoes_section, MF-38 para _update_notes_section, MF-39 para _update_tasks_section, MF-40 para _update_obrigacoes_section, MF-41 para _update_notes_section, MF-42 para _update_tasks_section, MF-43 para _update_obrigacoes_section, MF-44 para _update_dashboard_section), corre√ß√µes de bugs (ex.: AttributeError em _dashboard_view) e impacto zero no comportamento. Devlog devlog-passwords-fase6.md para m√≥dulo Senhas (FASE 6), com +55 testes (unit√°rios/integra√ß√£o), cobertura 95.4%, fixtures para repo fake, corre√ß√µes em edge cases (ex.: None/empty strings em crypto).

Bugs de produ√ß√£o como BUG-PROD-AUTH-001 (remo√ß√£o de importlib.reload em auth para evitar falhas em testes) e BUG-PROD-SUITE-ISOLATION-001 (infraestrutura de isolamento com fixtures para monkeypatch, sys.modules cleanup, mock globals) resolvem contamina√ß√£o de estado em su√≠tes completas. Checklists como checklist_tarefas_priorizadas_v1.2.64_STABLE.md e checklist_tarefas_priorizadas.md priorizam tarefas por P0-P3, com foco em SEG, DEP, QA, TEST, DOC, BUILD, CODE, TOOL.

Cobertura detalhada em coverage_raw_v1.2.64.txt (relat√≥rio raw), coverage_map_v1.2.64.md (mapa por arquivo), coverage_scope_analysis.md (an√°lise de escopo pytest-cov, recomendando inclus√£o de infra/adapters/data/security), coverage_baseline_app_core.md (baseline para App Core incluindo src/adapters/infra/data/security, cobertura 37.28%>25%), coverage_dependencies_map.md (mapeamento de depend√™ncias para inclus√£o em coverage, classificando em Core Integral, Auxiliar, Dev-Only, Deprecated).

Cobertura packs como COVERAGE-PACK-05-EASY-WINS-SUMMARY.md (easy wins, 2025-01-XX): +83 testes em m√≥dulos core (ex.: src/modules/notas, src/app_core), cobertura global >56.1%, 5/7 m√≥dulos conclu√≠dos. COV-INFRA-001 (infra/settings.py 97.3%, infra/supabase/storage_client.py 87.1%), COV-SEC-001 (security/crypto.py 95.1%), cov_adapters_supabase_storage.md (adapters/storage/supabase_storage.py 78.9%), cov_data_supabase_repo.md (data/supabase_repo.py bloqueado por import circular), TEST-001 (suite para uploads/service.py com 47 testes).

Fixes espec√≠ficos como fix_auth_bootstrap_persisted_session.md (AttributeError em DummyApp.tk), fix_tests_cli_and_splash.md (erros em CLI/argparse e splash), fix_flags_tests.md (valida√ß√£o est√°vel de test_flags.py).

Auditorias como VERIFY-CHANGES-001.md (auditoria de mudan√ßas em v1.2.64, 44 modificados, 30 deletados, 47 novos), test_suite_healthcheck_v1.2.64.md (healthcheck da su√≠te com 23 falhas), test_suite_refactor_full_green_v1.2.64.md (su√≠te refatorada para 1253 passed, 43.78% coverage).

## Estrutura de Camadas e Depend√™ncias
A arquitetura segue um fluxo unidirecional: UI ‚Üí Core ‚Üí Domain ‚Üí Infra ‚Üí Adapter, evitando ciclos. Conven√ß√µes de nomenclatura refor√ßam clareza (ex.: UI usa *_view.py; Core usa *_service.py). Fixes recentes abordaram imports circulares, como entre adapters.storage.api e src (via app_core), resolvidos com TYPE_CHECKING e lazy loading via __getattr__ em src/__init__.py, quebrando ciclos sem alterar comportamento em runtime. Outro ciclo em hub.views.hub_screen ‚Üî notas.view foi resolvido movendo imports para dentro de fun√ß√µes. Mapa de m√≥dulos (module_map.json gerado por analyze_modules.py) confirma distribui√ß√£o: UI (76), Core (53), Infra (34), Adapter (5), Domain (4), Script (11), Third Party (0), total 183.

- **UI (Interface Gr√°fica)**: Telas e widgets em Tkinter/ttkbootstrap. Exemplos: main_window.py (janela principal com TopBar, AppMenuBar, NavigationController, StatusFooter), login_dialog.py (di√°logo de login com valida√ß√£o, binds e exce√ß√µes), sidebar.py, widgets como autocomplete_entry.py e file_button.py. Features t√™m views dedicadas (ex.: auditoria/view.py, clientes/main_screen.py, passwords/passwords_screen.py, hub/viewmodels/notes_vm.py para ordena√ß√£o de notas, lixeira/views/lixeira.py para gerenciamento de lixeira com progress dialogs e valida√ß√µes, pdf_preview/views/main_window.py para visualiza√ß√£o de PDFs com zoom e navega√ß√£o). Refatora√ß√µes UI extra√≠ram l√≥gica pura para helpers em m√≥dulos como pdf_preview (c√°lculos de zoom, navega√ß√£o), clientes (estados de bot√µes, stats, sele√ß√£o, filtros, batch), hub e lixeira.

- **Core (N√∫cleo)**: L√≥gica de neg√≥cio, servi√ßos e controladores. Inclui navigation_controller.py (navega√ß√£o entre frames com factory pattern), models.py, servi√ßos como upload_service.py, lixeira_service.py (gerenciamento de lixeira com storage paths), clientes/service.py (447 linhas para CRUD, duplicatas, lixeira), notes_service.py (gerenciamento de notas com normaliza√ß√£o de autores, exce√ß√µes transit√≥rias), session_service.py (cache de sess√£o, user/role/org_id), app_actions.py (a√ß√µes principais como novo/editar/excluir cliente, lixeira, uploads, PDF converter), auth_bootstrap.py (bootstrap de autentica√ß√£o com splash, refresh, healthcheck), auditoria/application/controller.py (controle de auditoria com valida√ß√£o e exce√ß√µes), auditoria/service.py (servi√ßo de auditoria com queries e storage), auditoria/archives.py (gerenciamento de arquivos compactados com extra√ß√£o e valida√ß√£o), clientes/controllers (connectivity.py para checagem de conectividade, batch_operations.py para opera√ß√µes em lote, column_controls_layout.py para posicionamento de controles, filter_sort_manager.py para filtros e ordena√ß√£o, connectivity_state_manager.py para gerenciamento de estados de rede, event_router.py para roteamento de eventos, ui_state_manager.py para gerenciamento de estados de UI, main_screen_actions.py para a√ß√µes da tela principal, selection_manager.py para gerenciamento de sele√ß√£o, rendering_adapter.py para adapta√ß√£o de renderiza√ß√£o, pick_mode_manager.py para modo de sele√ß√£o), features/regulations/service.py (gerenciamento de obriga√ß√µes regulat√≥rias com CRUD, normaliza√ß√£o PT-BR, campos opcionais), uploads/service.py (gerenciamento de uploads/downloads/exclus√µes com handling de erros).

- **Domain (Dom√≠nio)**: Modelos e reposit√≥rios como domain_types.py (enums/dataclasses) e supabase_repo.py.

- **Infra (Infraestrutura)**: Banco, rede e seguran√ßa. Principais: supabase_client.py (singleton), supabase_auth.py, net_session.py (HTTP com retry), crypto.py. Inclui timeouts HTTP diferenciados (LIGHT/HEAVY). Stubs como typings/postgrest/__init__.pyi corrigidos para compatibilidade de tipos (ex.: PostgrestAPIError com dict[str, str]). Cobertura elevada em infra/settings.py (97.3%), infra/supabase/storage_client.py (87.1%).

- **Adapter (Adaptadores)**: Integra√ß√µes externas, focando storage via Supabase (supabase_storage.py, storage/api.py, port.py). Suporta normaliza√ß√£o de buckets/keys, remo√ß√£o de acentos, detec√ß√£o de content-type. Cobertura elevada em adapters/storage/supabase_storage.py (78.9%).

- **Script (Utilit√°rios)**: Ferramentas de dev como analyze_modules.py (gera√ß√£o de module_map.json para classifica√ß√£o por camada), pdf_batch_from_images.py (convers√£o de imagens .jpg/.jpeg em PDFs de subpastas, com op√ß√µes overwrite/delete), analyze_path_errors.py (an√°lise de erros Path/PathLike do Pyright para CompatPack-03), analyze_linters.py (an√°lise de relat√≥rios Ruff/Flake8 com agrupamento por c√≥digo/arquivo), analyze_pyright_errors.py (an√°lise de erros Pyright com filtro para src/infra/adapters), analyze_config_errors.py (filtro para erros em config/settings/environment/constants e return types simples), analyze_pyright_warnings.py (an√°lise de warnings Pyright com agrupamento por regra/arquivo), analyze_supabase_errors.py (an√°lise de erros em Supabase repo/client para CompatPack-08, priorizando return types unknown), analyze_style_issues.py (an√°lise de issues de estilo Ruff/Flake8 com agrupamento), analyze_security.py (runner para Bandit em produ√ß√£o, excluindo tests), analyze_top_errors.py (top arquivos/erros Pyright, breakdown por regra, safe rules como reportArgumentType), analyze_unknown_errors.py (erros Unknown types em src/ui/core/services para CompatPack-04). Removido script auxiliar fix_encoding_pick_mode.py (usado em FIX-CLIENTES-002) para limpar workspace e eliminar erros de Pylance.

Regras de depend√™ncia: Camadas superiores importam inferiores. Viola√ß√µes atuais ser√£o corrigidas em ModularPacks futuros (ex.: modularizar features, refatorar ciclos, dependency injection). Fluxo de dados: UI captura inputs ‚Üí Core valida/orquestra ‚Üí Domain acessa dados ‚Üí Infra executa (ex.: Supabase queries) ‚Üí Adapters integram.

## Entrypoints e Configura√ß√µes
- **Principal**: python -m src.app_gui ‚Äî Configura cloud-only, logging, exce√ß√µes, Tkinter. Carrega .env com suporte a PyInstaller.
- **Alternativo**: python main.py ‚Äî Wrapper para compatibilidade.
- **Build**: rcgestor.spec para execut√°vel Windows (onefile, UPX, assets incluindo 7zip e migrations).

Configura√ß√µes incluem timeouts HTTP: LIGHT (connect=10s, read/write=30s) para opera√ß√µes r√°pidas; HEAVY (60s) para uploads. Alias HTTPX_TIMEOUT aponta para LIGHT por padr√£o. Redu√ß√£o de logs em HUB (ex.: polling, WinError 10013) convertidos de INFO para DEBUG, eliminando ru√≠do em produ√ß√£o sem perda de debugabilidade (RC_LOG_LEVEL=DEBUG para acessar). pytest.ini atualizado com --import-mode=importlib para resolver conflitos de namespace em testes.

## Features Principais
O projeto cobre m√≥dulos como SIFAP (sifap/logic.py e view.py), Farm√°cia Popular (farmacia/controller.py e view.py), Gest√£o de Clientes (cliente/main_screen.py, service.py para CRUD, duplicatas, lixeira), Auditoria (features/auditoria/*), Fluxo de Caixa (cashflow/service.py e dialogs.py), Busca (search/controller.py e view.py), Upload (upload_service.py), Lixeira (lixeira_service.py e lixeira.py), Senhas (passwords_screen.py com integra√ß√£o a Clientes), HUB (hub/viewmodels/notes_vm.py para gerenciamento de notas com ordena√ß√£o: fixadas no topo por data DESC, n√£o-fixadas por data ASC para novas embaixo), PDF Preview (pdf_preview/views/main_window.py para visualiza√ß√£o de PDFs/imagens com zoom, navega√ß√£o e download) e Regulations (features/regulations/service.py para obriga√ß√µes regulat√≥rias com CRUD, normaliza√ß√£o PT-BR, campos opcionais).

### Feature de Auditoria
Permite revis√µes formais por cliente, status e gerenciamento de documentos no bucket. UI em Tkinter consome servi√ßo sem acesso direto a infra. Refatora√ß√µes incluem cobertura elevada em controller.py, service.py e archives.py.

- **Arquivos**: auditoria/view.py (widgets/eventos), auditoria/service.py (queries Supabase, storage ops, extra√ß√£o de .zip/.rar/.7z), auditoria/application/controller.py (controle com valida√ß√£o, exce√ß√µes, callbacks), auditoria/archives.py (gerenciamento de arquivos compactados com extra√ß√£o, valida√ß√£o, handling de duplicatas).
- **Depend√™ncias**: view.py ‚Üí service.py ‚Üí infra/*.
- **Fun√ß√µes**: Fetch (clients/auditorias), CRUD (start/update/delete), Contexto (org_id/storage), Storage (ensure folder, list/upload/remove), Arquivos (validate/extract); controller: valida√ß√µes, callbacks de progresso/cancelamento; archives: extra√ß√£o segura, handling de paths, skip/replace/rename para duplicatas.

### Feature de Gest√£o de Clientes
Inclui tela principal (main_screen.py), formul√°rios, controllers e service.py para opera√ß√µes como extrair dados de CNPJ, checar duplicatas (por CNPJ/raz√£o/n√∫mero), mover para lixeira, restaurar/excluir, atualizar status. Suporta normaliza√ß√£o de payloads, migra√ß√£o de pastas. Recente atualiza√ß√£o (FEATURE-CLIENTES-001): Ocultar bot√µes de batch na tela principal para simplificar UX, mantendo infraestrutura para reuso (ex.: em Lixeira). Refatora√ß√£o UI (REFACTOR-UI-007 Fases 01-07): Extra√≠das fun√ß√µes puras para estados de bot√µes, stats de novos clientes, parsing de datas, l√≥gica de sele√ß√£o (get_selected_ids, has_selection, get_selection_count, etc.), filtros (apply_status_filter, apply_search_filter, normalize_filter_input, etc.), batch operations (can_batch_delete/restore/export, get_batch_action_label, validate_batch_selection, format_batch_confirmation_message, format_batch_success_message, format_batch_error_message, should_enable_batch_buttons, calculate_batch_button_states), integra√ß√£o (get_selected_ids, update_batch_buttons_state), UI elements (bot√µes batch, callbacks placeholders) e l√≥gica batch real (_on_batch_delete/restore/export_clicked com confirma√ß√£o, progress, feedback; m√©todos batch no ViewModel). Cobertura elevada em controllers como connectivity.py, batch_operations.py, column_controls_layout.py, filter_sort_manager.py, connectivity_state_manager.py, event_router.py, ui_state_manager.py, main_screen_actions.py, selection_manager.py, rendering_adapter.py, pick_mode_manager.py.

- **Arquivos**: clientes/main_screen.py (UI principal), clientes/service.py (l√≥gica de neg√≥cio), clientes/controllers (connectivity.py para checagem de rede, batch_operations.py para lote, column_controls_layout.py para posicionamento de controles, filter_sort_manager.py para filtros/ordena√ß√£o, connectivity_state_manager.py para estados de rede, event_router.py para roteamento de eventos, ui_state_manager.py para estados de UI, main_screen_actions.py para a√ß√µes da tela principal, selection_manager.py para sele√ß√£o, rendering_adapter.py para renderiza√ß√£o, pick_mode_manager.py para modo de pick).
- **Fun√ß√µes Auxiliares**: _current_utc_iso, _extract_cliente_id, _ensure_str, _resolve_current_id, _conflict_id, _filter_self, _build_conflict_ids; calculate_button_states, calculate_new_clients_stats, format_clients_summary, parse_created_at_date, extract_created_at_from_client; get_selected_ids, has_selection, get_selection_count, is_single_selection, is_multi_selection, get_first_selected_id, validate_selection_count, normalize_selected_ids; apply_status_filter, apply_search_filter, normalize_filter_input, matches_search_text, get_client_field_value, combine_filters; can_batch_delete/restore/export, get_batch_action_label, validate_batch_selection, format_batch_confirmation_message, format_batch_success_message, format_batch_error_message, should_enable_batch_buttons, calculate_batch_button_states; connectivity: check_connectivity, is_stable_connection; batch_operations: process_batch_delete/restore/export, BatchOperationResult, BatchValidationResult; column_controls_layout: calculate_label_position, calculate_checkbox_position, get_column_bounds, validate_control_bounds; filter_sort_manager: apply_filters_and_sort, update_search_filter, update_status_filter, sort_clients_by_column; connectivity_state_manager: update_connectivity_state, get_current_state, handle_state_change, is_online/unstable/offline; event_router: roteamento de eventos (sele√ß√£o, duplo-clique, Enter), EventContext; ui_state_manager: update_ui_state, get_current_ui_state, handle_ui_change; main_screen_actions: a√ß√µes como novo/editar/excluir, integra√ß√µes com service; selection_manager: gerenciamento de sele√ß√£o no Treeview; rendering_adapter: adapta√ß√£o de dados para renderiza√ß√£o; pick_mode_manager: enter/exit pick mode, handling de callbacks.
- **Neg√≥cio**: extrair_dados_cartao_cnpj_em_pasta (PDF handling), checar_duplicatas_para_form, get/fetch_cliente_by_id.
- **Lixeira/Storage**: mover_para_lixeira, restaurar_clientes, excluir_simples/definitivamente, listar_na_lixeira, update_status_and_observacoes, _resolve_current_org_id, _gather_paths, _remove_cliente_storage, _list_storage_children (ignorar n√£o-dict), _gather_all_paths (ignorar sem name), _remove_storage_prefix (retorno 0 se vazio).

### Feature de Senhas (FEATURE-SENHAS-001 e 002)
Integra√ß√£o com Clientes via pick mode para sele√ß√£o de cliente em Nova Senha. Fluxo simplificado: Seleciona cliente primeiro (pick mode), depois abre di√°logo pr√©-preenchido. Elimina coexist√™ncia de di√°logo e pick mode, desabilita bot√£o "Selecionar Cliente..." ap√≥s pr√©-sele√ß√£o.

- **Arquivos**: passwords_screen.py (orquestra√ß√£o), PasswordDialog (UI), repository.py (CRUD com client_id opcional), supabase_repo.py (persist√™ncia com client_id).
- **Fluxo**: _on_new_password_clicked ‚Üí navigate_to("clients_picker") ‚Üí _handle_client_picked_for_new_password ‚Üí _open_new_password_dialog com client_data.
- **Backend**: add_password/update_password aceitam client_id; fetch_passwords_by_client_id para listagem.
- **UX**: Cliente exibido como "ID X ‚Äì Raz√£o (CNPJ)"; campo preenchido automaticamente.

### Modo de Sele√ß√£o (Pick Mode)
Usado em integra√ß√µes como Senhas. Fixes m√∫ltiplos corrigiram layout (TclError em pack vs grid), textos UTF-8 (mojibake como "√∞≈∏" ‚Üí "üîç"), lockdown de a√ß√µes indevidas (desabilitar Novo/Editar/Lixeira/Conversor PDF), e garantia de textos via constantes (PICK_MODE_BANNER_TEXT, etc.). Fluxo: _enter_pick_mode_ui desabilita bot√µes; _leave_pick_mode_ui restaura. Duplo-clique/Enter confirma sele√ß√£o.

- **Fixes Principais**: FIX-CLIENTES-001 (layout adaptativo), 002 (UX e encoding), 003 (textos e bot√µes), 005 (lockdown total), 006 (garantia de constantes). FIX-SENHAS-CLIENTES-004: Centraliza orquestra√ß√£o em PasswordsScreen para reabrir di√°logo se fechado durante pick.

### Feature de HUB (Notas)
Gerenciamento de notas com ordena√ß√£o via _sort_notes() em notes_vm.py: Fixadas no topo por created_at DESC (recentes primeiro); n√£o-fixadas por created_at ASC (antigas primeiro, novas embaixo). Normaliza√ß√£o de autores via email (prefixo sem @). Redu√ß√£o de logs repetitivos (polling, WinError 10013) para DEBUG, mantendo INFO para eventos cr√≠ticos. Refatora√ß√£o UI (REFACTOR-UI-003): Extra√≠das fun√ß√µes puras para estilos de bot√µes, estados de UI, hash de conte√∫do, cooldown de atualiza√ß√µes, normaliza√ß√£o de notas.

- **Arquivos**: hub/viewmodels/notes_vm.py (ordena√ß√£o, _sort_notes), core/services/notes_service.py (CRUD, exce√ß√µes transit√≥rias como "temporarily unavailable", normaliza√ß√£o de author_email).
- **Fun√ß√µes**: is_transient_net_error, handle_table_missing_error, _check_auth_error, normalize_author_email_for_org; calculate_module_button_style, calculate_notes_ui_state, calculate_notes_content_hash, should_skip_notes_update, normalize_notes_for_hashing.

### Feature de Lixeira
Gerenciamento de itens deletados com restaura√ß√£o/exclus√£o definitiva, progress dialogs e valida√ß√µes. Refatora√ß√£o UI em duas fases (REFACTOR-UI-004 Fase01 e Fase02): Extra√≠das 14 fun√ß√µes puras para lixeira_helpers.py cobrindo status text, button states, valida√ß√£o de sele√ß√£o, extra√ß√£o de campos, mensagens de confirma√ß√£o/progress/resultados, singleton management, progress percentage, normaliza√ß√£o de rows, formata√ß√£o de autores/timestamps, parsing de erros.

- **Arquivos**: lixeira/views/lixeira.py (UI principal), lixeira_helpers.py (fun√ß√µes puras).
- **Fun√ß√µes**: format_trash_status_text, calculate_trash_button_states, validate_selection_for_action, extract_field_value, format_confirmation_message, format_progress_text, format_result_message, should_open_new_trash_window, should_refresh_trash_window, calculate_progress_percentage, normalize_trash_row_data, format_author_initial, format_timestamp_with_author, parse_error_list_for_display.

### Feature de PDF Preview
Visualiza√ß√£o de PDFs e imagens com navega√ß√£o, zoom e download. Refatora√ß√£o UI em tr√™s fases (REFACTOR-UI-001, 005 Fase02, 006 Fase03): Extra√≠das fun√ß√µes puras para detec√ß√£o de tipo de arquivo, formata√ß√£o de labels, c√°lculo de primeira p√°gina vis√≠vel, estados de bot√µes de download, c√°lculos de zoom (calculate_zoom_step, zoom_to_fit_width, get_zoom_anchor, is_zoom_threshold_reached), navega√ß√£o de p√°ginas (get_next_page_index, get_previous_page_index, get_first_page_index, get_last_page_index, validate_page_index).

- **Arquivos**: pdf_preview/views/main_window.py (UI), view_helpers.py (fun√ß√µes puras).
- **Fun√ß√µes**: is_pdf_or_image, format_page_label, find_first_visible_page, calculate_button_states; calculate_zoom_step, zoom_to_fit_width, get_zoom_anchor, is_zoom_threshold_reached; get_next_page_index, get_previous_page_index, get_first_page_index, get_last_page_index, validate_page_index.

### Feature de Uploads
Gerenciamento de uploads, downloads e exclus√µes de arquivos com handling de erros, progress e cancelamento.

- **Arquivos**: uploads/service.py (l√≥gica de uploads).
- **Fun√ß√µes**: Upload/download/delete ops, handling de exce√ß√µes, callbacks de progress.

### Feature de Regulations
Gerenciamento de obriga√ß√µes regulat√≥rias com CRUD, normaliza√ß√£o PT-BR, campos opcionais (reference_start/end, notes), l√≥gica de completed_at para status done.

- **Arquivos**: features/regulations/service.py (CRUD e normaliza√ß√£o).
- **Fun√ß√µes**: create_obligation, update_obligation, delete_obligation; normaliza√ß√£o de status (PENDENTE, EM ANDAMENTO, CONCLUIDO, ATRASADO, OUTRO).

## Decis√µes Arquiteturais (ADRs)
Documentadas para rastreabilidade.

### ADR-0001: HTTP Timeout Strategy (Accepted, 2025-11-10)
Dois variantes: LIGHT (30s) para leves; HEAVY (60s) para pesadas. Alias para compatibilidade.

## Qualidade e Testes
Iniciativas focam em cobertura (meta ‚â•95%), seguran√ßa e valida√ß√µes via microfases (TEST-001 + QA-003). Usam pytest, coverage.py, ruff, pyright, bandit, vulture. Cobertura global melhorada com foco em branches, edges e exce√ß√µes. Relat√≥rios QA globais (2025-12-12) mostram ruff/format pass, pyright com 9 errors (ex.: type mismatches em data/supabase_repo.py, infra/supabase_client.py), bandit com 6-15 LOW issues (justificados, ex.: MD5 para compara√ß√£o n√£o-crypto), vulture com 5 dead code, pytest com 23 failures (ex.: p√≥s-refactor HUB, Tcl/Tk ausente em testes GUI). An√°lise geral (analise_geral_projeto_v1.4.05.md, 2025-12-09) indica cobertura global 65.2% (24.257 statements, 8.195 missing), pontos fortes em headless (95-100%), fracos em UI (30-50%), recomenda microfases em ondas de 4, priorizando uploads/regulations/app_core/auditoria, meta 6 meses: 75-80% global, refactor UI para headless separation.

### Microfases de Cobertura
- **app_actions.py (2025-11-27)**: 56.6% ‚Üí 96.6% (+40pp, 41 testes). Cobriu editar_cliente, _get_selected_cliente_id, editar_cliente (exce√ß√µes), lixeira, uploads, PDF converter.
- **auth_bootstrap.py (2025-01-21)**: 33.3% ‚Üí 96.2% (+62.9pp, 58 testes). Cobriu ensure_logged, splash, refresh, healthcheck, exce√ß√µes.
- **lixeira_service.py (2025-01-XX)**: 81.7% ‚Üí 95.9% (+14.2pp, 24 testes). Cobriu storage edges (_list_storage_children ignora n√£o-dict, _gather_all_paths ignora sem name).
- **clientes/service.py (2025-01-28)**: 86.3% ‚Üí 95.9% (+9.6pp, 81 testes). Cobriu auxiliares, neg√≥cio, lixeira/storage; edges como None, vazios, exce√ß√µes.
- **navigation_controller.py (2025-11-28)**: 83.9% ‚Üí 100% (+16.1pp, 12 testes). Cobriu show_frame, factory pattern, exce√ß√µes em lift/pack.
- **session_service.py (2025-11-27)**: 98.7% ‚Üí 100% (+1.3pp, 20 testes). Cobriu cache hits, fallbacks, exce√ß√µes em queries.
- **login_dialog.py (2025-11-27)**: 12.5% ‚Üí 96.9% (+84.4pp, 39 testes). Cobriu inicializa√ß√£o, valida√ß√£o, login sucesso/falha, binds, exce√ß√µes.
- **notes_service.py (2025-01-XX)**: 85.7% ‚Üí 98.6% (+12.9pp, 83 testes). Cobriu exce√ß√µes transit√≥rias, normaliza√ß√£o de autores, edges como PGRST205.
- **main_window.py (2025)**: 15.2% ‚Üí 15.2% (imposs√≠vel sem refatora√ß√£o GUI; requer Tk root funcional, falhas em mocks de tb.Window e ttk.Separator).
- **app_core.py (2025-12-09)**: 71.7% ‚Üí 98.8% (+27.1pp, 21 testes). Cobriu exception handling, fallbacks de import, branches (NO_FS, CLOUD_ONLY).
- **clientes/controllers/event_router.py (2025-12-09)**: 60.0% ‚Üí 100% (+40pp, 33 testes). Cobriu EventContext, roteamento de eventos (sele√ß√£o, duplo-clique, Enter), pick mode handling.
- **auditoria/archives.py (2025-12-09)**: 22.5% ‚Üí 97.3% (+74.8pp, 54 testes). Cobriu extra√ß√£o segura, handling de duplicatas (skip/replace/rename), progress/cancelamento, cleanup.
- **clientes/controllers/connectivity.py (2025-12-09)**: 26.7% ‚Üí 98.3% (+71.6pp, 19 testes). Cobriu check_connectivity, is_stable_connection, exce√ß√µes de rede.
- **clientes/controllers/batch_operations.py (2025-12-09)**: 36.7% ‚Üí 100% (+63.3pp, 27 testes). Cobriu process_batch_delete/restore/export, BatchOperationResult, BatchValidationResult, properties (is_complete_success, is_partial_success).
- **clientes/controllers/column_controls_layout.py (2025-12-09)**: 0% ‚Üí 100% (+100pp, 25 testes). Cobriu calculate_label_position, calculate_checkbox_position, get_column_bounds, validate_control_bounds.
- **auditoria/service.py (2025-12-09)**: 81.8% ‚Üí 97.7% (+15.9pp, 30 testes). Cobriu queries, storage ops, exce√ß√µes offline, cache global.
- **clientes/controllers/filter_sort_manager.py (2025-12-09)**: 0% ‚Üí 100% (+100pp, 22 testes). Cobriu apply_filters_and_sort, update_search_filter, update_status_filter, sort_clients_by_column.
- **clientes/controllers/connectivity_state_manager.py (2025-06-XX)**: 63.6% ‚Üí 100% (+36.4pp, 31 testes). Cobriu update_connectivity_state, get_current_state, handle_state_change, is_online/unstable/offline.
- **auditoria/application/controller.py (2025-12-09)**: 38.5% ‚Üí 100% (+61.5pp, 50 testes). Cobriu valida√ß√µes, callbacks, exce√ß√µes, integra√ß√µes com service.
- **clientes/controllers/rendering_adapter.py (2025-12-09)**: 34.4% ‚Üí 100% (+65.6pp, 23 testes). Cobriu adapta√ß√£o de renderiza√ß√£o, exce√ß√µes de Treeview.
- **features/regulations/service.py (2025-12-09)**: 69.9% ‚Üí 95.6% (+25.7pp, 23 testes). Cobriu CRUD, normaliza√ß√£o PT-BR, campos opcionais, completed_at para status done.
- **clientes/controllers/ui_state_manager.py (2025-12-09)**: 61.0% ‚Üí 100% (+39.0pp, 33 testes). Cobriu update_ui_state, get_current_ui_state, handle_ui_change.
- **uploads/service.py (2025-12-09)**: 65.1% ‚Üí 100% (+34.9pp, 18 testes). Cobriu uploads/downloads/deletes, handling de erros, progress.
- **clientes/controllers/main_screen_actions.py (2025-12-09)**: 79.2% ‚Üí 100% (+20.8pp, 16 testes). Cobriu a√ß√µes da tela principal, integra√ß√µes com service.
- **clientes/controllers/selection_manager.py (2025-12-09)**: 46.0% ‚Üí 100% (+54.0pp, 34 testes). Cobriu gerenciamento de sele√ß√£o no Treeview.

### Refatora√ß√µes UI (REFACTOR-UI S√©rie)
Extra√ß√£o de l√≥gica pura para helpers, elevando cobertura sem Tkinter mocks. API-only approach em fases iniciais, seguido de integra√ß√£o.

- **REFACTOR-UI-001 (pdf_preview/main_window.py, 2025-11-28)**: 9.6% ‚Üí +31 testes (4 fun√ß√µes: is_pdf_or_image, format_page_label, find_first_visible_page, calculate_button_states). 100% cobertura helpers.
- **REFACTOR-UI-002 (clientes/main_screen.py, 2025-01-28)**: 9.8% ‚Üí +35 testes (5 fun√ß√µes: calculate_button_states, calculate_new_clients_stats, format_clients_summary, parse_created_at_date, extract_created_at_from_client). 100% cobertura helpers.
- **REFACTOR-UI-003 (hub/hub_screen.py, 2025-11-28)**: 14.0% ‚Üí +42 testes (5 fun√ß√µes: calculate_module_button_style, calculate_notes_ui_state, calculate_notes_content_hash, should_skip_notes_update, normalize_notes_for_hashing). 100% cobertura helpers.
- **REFACTOR-UI-004 Fase01 (lixeira/lixeira.py, 2025-11-28)**: +38 testes (7 fun√ß√µes: format_trash_status_text, calculate_trash_button_states, validate_selection_for_action, extract_field_value, format_confirmation_message, format_progress_text, format_result_message). 100% cobertura helpers.
- **REFACTOR-UI-004 Fase02 (lixeira/lixeira.py, 2025-11-28)**: +31 testes (7 fun√ß√µes: should_open_new_trash_window, should_refresh_trash_window, calculate_progress_percentage, normalize_trash_row_data, format_author_initial, format_timestamp_with_author, parse_error_list_for_display). 100% cobertura helpers.
- **REFACTOR-UI-005 Fase02 (pdf_preview/main_window.py, 2025-11-28)**: +52 testes (4 fun√ß√µes: calculate_zoom_step, zoom_to_fit_width, get_zoom_anchor, is_zoom_threshold_reached). 100% cobertura helpers; total acumulado 83 testes em view_helpers.
- **REFACTOR-UI-006 Fase03 (pdf_preview/main_window.py, 2025-11-28)**: +49 testes (5 fun√ß√µes: get_next_page_index, get_previous_page_index, get_first_page_index, get_last_page_index, validate_page_index). 100% cobertura helpers; total acumulado 132 testes em view_helpers.
- **REFACTOR-UI-007 Fase02 (clientes/main_screen.py, 2025-11-28)**: +53 testes (8 fun√ß√µes: get_selected_ids, has_selection, get_selection_count, is_single_selection, is_multi_selection, get_first_selected_id, validate_selection_count, normalize_selected_ids). 100% cobertura helpers; total 270 testes em clientes.
- **REFACTOR-UI-007 Fase03 (clientes/main_screen.py, 2025-11-28)**: +53 testes (6 fun√ß√µes: apply_status_filter, apply_search_filter, normalize_filter_input, matches_search_text, get_client_field_value, combine_filters). 100% cobertura helpers; total 323 testes em clientes.
- **REFACTOR-UI-007 Fase04 (clientes/main_screen.py, 2025-11-28)**: +46 testes (8 fun√ß√µes: can_batch_delete/restore/export, get_batch_action_label, validate_batch_selection, format_batch_confirmation_message, format_batch_success_message, format_batch_error_message, should_enable_batch_buttons, calculate_batch_button_states). 100% cobertura helpers; total 369 testes em clientes.
- **REFACTOR-UI-007 Fase05 (clientes/main_screen.py, 2025-11-28)**: Integra√ß√£o de batch com 2 m√©todos (_get_selected_ids, _update_batch_buttons_state); +11 testes integra√ß√£o; total 380 testes em clientes.
- **REFACTOR-UI-007 Fase06 (clientes/main_screen.py, 2025-11-28)**: UI elements para batch (3 bot√µes, callbacks placeholders); +16 testes UI; total 396 testes em clientes.
- **REFACTOR-UI-007 Fase07 (clientes/main_screen.py, 2025-11-28)**: L√≥gica batch real (_on_batch_delete/restore/export_clicked com confirma√ß√£o, progress, feedback; m√©todos batch no ViewModel); +18 testes; total 414 testes em clientes.

### Fixes de Seguran√ßa e QA
- **Bandit**: Resolvidos 9 B110/B112 com logger.debug; scans globais com 6-15 LOW issues (justificados, ex.: MD5 para compara√ß√£o n√£o-crypto).
- **Ruff**: De 49 erros para 0 via --fix e manuais (ex.: F401 imports, E702 semicolons).
- **Pyright**: Cleanup de 9 errors (ex.: __all__ mismatches, protocolos GUI como AfterCapableApp/SplashLike, callbacks como UserChangeCallback); stubs postgrest corrigidos para dict[str, str] em APIError. QA-DELTA-19 (CompatPack-13, 2025-01-XX): Corre√ß√µes para 10 erros √≥bvios (reportRedeclaration, reportArgumentType, messagebox parent), em arquivos como ui/messagebox.py, ui/forms/forms.py, ui/forms/pipeline.py; estrat√©gia: an√°lise via analyze_top_errors.py, foco em Group A (n√£o-cr√≠tico). Classifica√ß√£o em errors_classification.md para CompatPack-17: 59 erros em A (17, corre√ß√µes seguras), B (33, ignores em stubs/libs), C (9, ignores em cr√≠ticas como adapters/storage, infra/supabase).
- **Vulture**: De 117 para 0 dead code em src/ (ex.: remo√ß√£o de fun√ß√µes/vars n√£o usadas).
- **Pytest**: Corrigidos 14 erros de collect via --import-mode=importlib; 23 failures restantes (ex.: assertions falhas p√≥s-refactor HUB, Tcl/Tk ausente).

Fixes t√©cnicos: Remo√ß√£o de script auxiliar (FIX-TECH-001); quebra de imports circulares (FIX-IMPORT-CIRCULAR-STORAGE-API); QA-003 para postgrest stub e bandit; fix_auth_bootstrap_persisted_session.md (AttributeError em DummyApp.tk), fix_tests_cli_and_splash.md (erros em CLI/argparse e splash), fix_flags_tests.md (valida√ß√£o est√°vel de test_flags.py).

## Conven√ß√µes e Ferramentas
- **Nomenclatura**: Por camada.
- **An√°lise**: analyze_modules.py; linters (ruff, flake8), pyright, pytest, coverage.py, bandit, vulture.
- **Refer√™ncias**: C√≥digo em src/, infra/; docs em docs/qa-history/; configs em pyproject.toml, pytest.ini. README.md em devtools/qa descreve estrutura, uso de scripts e relat√≥rios (ex.: bandit-report.json, pip-audit.json).

## Pr√≥ximos Passos
- ModularPacks: Features isoladas, refatorar depend√™ncias.
- Cobertura: Packs para viewmodel.py, forms/; microfases para profiles_service.py, main_window.py (ap√≥s refatora√ß√£o GUI), outros controllers como ui_builder.py, layout_manager.py, trash_manager.py, connectivity_state_manager.py (j√° 100%).
- Features: Tela de Lixeira com batch; export real (CSV/Excel); progress dialog para batch delete.
- Qualidade: Corrigir pyright errors restantes, pytest failures; m√©tricas de timeouts; testes E2E; CI/CD com ruff/format checks. COVERAGE-PACK-05 (easy wins, 2025-01-XX): +83 testes em m√≥dulos core (ex.: src/modules/notas, src/app_core), cobertura global >56.1%.
- Entrega: Merge qa/fixpack-04 (40 commits ahead); release v1.4.05; code reviews.

Este resumo unificado pode ser expandido com mais arquivos, reorganizando para coes√£o.
