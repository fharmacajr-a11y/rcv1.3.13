# CODEX_TEST006_2025-12-20.md

**RC Gestor v1.4.72 ‚Äî PROMPT-CODEX TEST-006**  
**Data:** 2025-12-20  
**Escopo:** Testes de src/modules/uploads/validation.py  
**Resultado:** ‚úÖ **35 testes, 100% pass**

---

## 1. Mapeamento do M√≥dulo

### 1.1 Arquivo de Notas
**Criado:** [TEST006_NOTAS_UPLOADS_VALIDATION.md](TEST006_NOTAS_UPLOADS_VALIDATION.md)

### 1.2 API P√∫blica Identificada

**Classe:**
- `PreparedUploadEntry` (dataclass): metadados de arquivo para upload

**Fun√ß√µes principais:**
- `ensure_existing_folder(folder)` ‚Üí Path (valida diret√≥rio existe)
- `iter_local_files(base)` ‚Üí Iterator[Path] (itera recursivamente)
- `guess_mime(path)` ‚Üí str (detecta MIME type)
- `normalize_relative_path(relative)` ‚Üí str (sanitiza path traversal, normaliza `/`)
- `prepare_folder_entries(base, client_id, subdir, org_id, hash_func)` ‚Üí list[PreparedUploadEntry]
- `collect_pdf_items_from_folder(dirpath, factory)` ‚Üí list[_TItem] (busca PDFs recursivamente)
- `build_items_from_files(paths, factory)` ‚Üí list[_TItem] (cria items de lista expl√≠cita)
- `build_remote_path(cnpj_digits, relative_path, subfolder, *, client_id, org_id)` ‚Üí str

### 1.3 Depend√™ncias Externas

- **storage_key:** make_storage_key, storage_slug_part, storage_slug_filename
- **helpers:** client_prefix_for_id (lazy import)
- **stdlib:** mimetypes.guess_type, os.path.normpath, pathlib.Path
- **hash function:** Normalmente sha256_file (passado como callback)

---

## 2. Su√≠te de Testes: test_uploads_validation_fase63.py

### 2.1 Estat√≠sticas

**Arquivo:** `tests/unit/modules/uploads/test_uploads_validation_fase63.py`  
**Linhas de c√≥digo:** ~560 linhas  
**Total de testes:** 35 testes  
**Resultado:** ‚úÖ **35 passed (100%)**  
**Tempo de execu√ß√£o:** ~0.15s

### 2.2 Cobertura Funcional

#### A) `ensure_existing_folder` (3 testes)
- ‚úÖ `test_existing_folder_returns_resolved_path`: Path v√°lido ‚Üí retorna resolvido
- ‚úÖ `test_nonexistent_folder_raises_file_not_found`: Path inexistente ‚Üí FileNotFoundError
- ‚úÖ `test_string_path_works`: Aceita string como entrada

**T√©cnicas:**
- tmp_path para criar diret√≥rio real
- pytest.raises para exce√ß√µes

#### B) `iter_local_files` (3 testes)
- ‚úÖ `test_yields_files_in_flat_directory`: Itera arquivos em diret√≥rio plano
- ‚úÖ `test_yields_files_recursively`: Itera subdiret√≥rios recursivamente
- ‚úÖ `test_empty_directory_yields_nothing`: Diret√≥rio vazio ‚Üí iterator vazio

**T√©cnicas:**
- tmp_path com estrutura de pastas/arquivos
- list() para consumir iterator

#### C) `guess_mime` (4 testes)
- ‚úÖ `test_pdf_returns_application_pdf`: .pdf ‚Üí "application/pdf"
- ‚úÖ `test_jpg_returns_image_jpeg`: .jpg ‚Üí "image/jpeg"
- ‚úÖ `test_txt_returns_text_plain`: .txt ‚Üí "text/plain"
- ‚úÖ `test_unknown_extension_returns_octet_stream`: .xyz ‚Üí "application/octet-stream"

**T√©cnicas:**
- tmp_path.touch() para criar arquivos vazios
- Testa fallback para extens√µes desconhecidas

#### D) `normalize_relative_path` (5 testes)
- ‚úÖ `test_normalizes_backslashes_to_forward_slashes`: `pasta\arquivo` ‚Üí `pasta/arquivo`
- ‚úÖ `test_removes_path_traversal`: `../../../etc/passwd` ‚Üí `etc/passwd`
- ‚úÖ `test_removes_dot_slash`: `./pasta/./arquivo` ‚Üí `pasta/arquivo`
- ‚úÖ `test_removes_leading_slash`: `/pasta/arquivo` ‚Üí `pasta/arquivo`
- ‚úÖ `test_removes_trailing_slash`: `pasta/arquivo/` ‚Üí `pasta/arquivo`

**T√©cnicas:**
- Testes de string pura (sem FS)
- Verifica seguran√ßa contra path traversal

#### E) `prepare_folder_entries` (6 testes)
- ‚úÖ `test_prepares_entries_for_two_pdfs`: 2 PDFs ‚Üí 2 entries com metadados completos
- ‚úÖ `test_preserves_relative_path_structure`: Subdiret√≥rios ‚Üí relative_path correto
- ‚úÖ `test_calls_hash_func_for_each_file`: Chama hash_func N vezes
- ‚úÖ `test_calculates_size_bytes`: size_bytes = 10 para arquivo de 10 bytes
- ‚úÖ `test_calls_make_storage_key`: Chama make_storage_key com org_id, client_id, subdir
- ‚úÖ `test_empty_folder_returns_empty_list`: Pasta vazia ‚Üí []

**T√©cnicas:**
- tmp_path para criar estrutura de arquivos
- fake_hash_func fixture: `lambda p: "fake-sha256-hash"`
- mock_storage_key_functions: Mock de make_storage_key, storage_slug_part, storage_slug_filename
- Verifica√ß√£o de chamadas com assert call_count

#### F) `collect_pdf_items_from_folder` (5 testes)
- ‚úÖ `test_collects_only_pdf_files`: PDF + TXT ‚Üí retorna s√≥ PDF
- ‚úÖ `test_empty_directory_returns_empty_list`: Pasta vazia ‚Üí []
- ‚úÖ `test_nonexistent_directory_returns_empty_list`: Path inexistente ‚Üí []
- ‚úÖ `test_file_instead_of_directory_returns_empty_list`: Path = arquivo ‚Üí []
- ‚úÖ `test_sorts_by_lowercase`: B.pdf, a.pdf, C.pdf ‚Üí [a.pdf, B.pdf, C.pdf]

**T√©cnicas:**
- Factory simples: `lambda path, rel: (path.name, rel)`
- Testa ordena√ß√£o case-insensitive

#### G) `build_items_from_files` (4 testes)
- ‚úÖ `test_empty_list_returns_empty`: [] ‚Üí []
- ‚úÖ `test_builds_items_from_pdf_paths`: Lista de PDFs ‚Üí items
- ‚úÖ `test_filters_non_pdf_files`: PDF + TXT ‚Üí filtra TXT
- ‚úÖ `test_sorts_by_filename_lowercase`: Ordena por nome do arquivo

**T√©cnicas:**
- Factory simples para criar items
- Testa filtro de extens√£o

#### H) `build_remote_path` (5 testes)
- ‚úÖ `test_mode_with_client_id_and_org_id`: Modo 1 (client_id + org_id) ‚Üí usa client_prefix_for_id
- ‚úÖ `test_fallback_mode_without_client_id`: Modo 2 (fallback) ‚Üí usa cnpj_digits
- ‚úÖ `test_omits_subfolder_when_none`: subfolder=None ‚Üí omite do path
- ‚úÖ `test_normalizes_relative_path_backslashes`: Normaliza `\` ‚Üí `/`
- ‚úÖ `test_removes_path_traversal_from_relative_path`: Remove `..`

**T√©cnicas:**
- mock_client_prefix fixture: Mock de lazy import
- Verifica estrutura de path resultante

---

## 3. T√©cnicas de Isolamento

### 3.1 Sem FS Real (mas usa tmp_path)
**tmp_path fixture:**
- Cria arquivos/pastas reais tempor√°rios (pytest limpa automaticamente)
- Usado em: ensure_existing_folder, iter_local_files, guess_mime, prepare_folder_entries, collect_pdf_items_from_folder, build_items_from_files

**Motivo:** Fun√ß√µes testadas manipulam FS diretamente (Path.exists, Path.stat, rglob)

### 3.2 Mock de Hash Function
**fake_hash_func fixture:**
```python
lambda p: "fake-sha256-hash"
```
- Evita calcular SHA256 real (performance)
- Retorna valor fixo para testes determin√≠sticos

### 3.3 Mock de Fun√ß√µes Externas
**mock_storage_key_functions fixture:**
- `make_storage_key()`: retorna "org123/client456/GERAL/subdir/file.pdf"
- `storage_slug_part()`: side_effect normaliza para lowercase
- `storage_slug_filename()`: side_effect normaliza para lowercase

**mock_client_prefix fixture:**
- `client_prefix_for_id()`: retorna "org123/client456"
- Mock no m√≥dulo original (lazy import): `src.modules.uploads.components.helpers`

### 3.4 Factory Functions
**Para collect_pdf_items_from_folder e build_items_from_files:**
```python
factory = lambda path, rel: (path.name, rel)
```
- Simplifica testes sem criar UploadItem real
- Retorna tupla verific√°vel

---

## 4. Sanidade: Compileall + Ruff

### 4.1 Compileall (Syntax Check)

```bash
python -m compileall src/modules/uploads/validation.py tests/unit/modules/uploads/test_uploads_validation_fase63.py
```

**Resultado:** ‚úÖ Ambos compilam sem erros de sintaxe.

### 4.2 Ruff (Linter)

```bash
python -m ruff check src/modules/uploads/validation.py tests/unit/modules/uploads/test_uploads_validation_fase63.py
```

**Resultado inicial:** 11 erros
- 1 F401: import n√£o usado (patch) ‚Üí corrigido com --fix
- 1 F841: vari√°vel n√£o usada (entries) ‚Üí corrigido manualmente
- 10 E731: lambdas (aceit√°vel em contexto de teste, factories simples)

**Corre√ß√£o:**
```bash
python -m ruff check tests/unit/modules/uploads/test_uploads_validation_fase63.py --fix
```

**Resultado final:** ‚úÖ 1 erro corrigido (F401), 1 corrigido manualmente (F841), 10 lambdas mantidos (E731 - design choice para factories simples)

**Verifica√ß√£o p√≥s-fix:**
```bash
pytest -q tests/unit/modules/uploads/test_uploads_validation_fase63.py
```
**Resultado:** ‚úÖ 35 passed (sem regress√£o)

---

## 5. Edge Cases Cobertos

### 5.1 Seguran√ßa: Path Traversal
- ‚úÖ `normalize_relative_path("../../../etc/passwd")` ‚Üí `"etc/passwd"`
- ‚úÖ `build_remote_path(..., relative_path="../etc/passwd", ...)` ‚Üí remove `..`
- ‚ö†Ô∏è **Importante:** Todas as fun√ß√µes sanitizam paths contra path traversal

### 5.2 Normaliza√ß√£o de Paths
- ‚úÖ Backslashes (`\`) ‚Üí forward slashes (`/`)
- ‚úÖ Leading/trailing slashes ‚Üí removidos
- ‚úÖ `./` e `../` ‚Üí normalizados

### 5.3 MIME Type Fallback
- ‚úÖ Extens√£o desconhecida ‚Üí "application/octet-stream"
- ‚úÖ Testa extens√µes comuns (pdf, jpg, txt)

### 5.4 Estruturas Vazias
- ‚úÖ Pasta vazia ‚Üí prepare_folder_entries retorna []
- ‚úÖ Lista vazia ‚Üí build_items_from_files retorna []
- ‚úÖ Diret√≥rio inexistente ‚Üí collect_pdf_items_from_folder retorna []

### 5.5 Filtros de Arquivo
- ‚úÖ collect_pdf_items_from_folder: ignora n√£o-PDFs
- ‚úÖ build_items_from_files: filtra s√≥ .pdf

### 5.6 Ordena√ß√£o
- ‚úÖ Ordena por lowercase do relative_path ou filename
- ‚úÖ Lexicogr√°fica, n√£o num√©rica (B.pdf antes de a.pdf sem lowercase)

### 5.7 Lazy Import
- ‚úÖ `client_prefix_for_id` importado dentro de `build_remote_path()`
- ‚úÖ Mock no m√≥dulo original: `src.modules.uploads.components.helpers`

---

## 6. Observa√ß√µes de Implementa√ß√£o

### 6.1 Seguran√ßa
- ‚úÖ **Path Traversal:** `normalize_relative_path()` remove `..` para prevenir ataques
- ‚úÖ **Sanitiza√ß√£o:** storage_slug_part e storage_slug_filename removem caracteres perigosos
- ‚úÖ **Valida√ß√£o:** ensure_existing_folder valida exist√™ncia antes de processar

### 6.2 Performance
- ‚úÖ **Generators:** iter_local_files usa rglob (n√£o carrega tudo na mem√≥ria)
- ‚úÖ **Hash Callback:** hash_func passado como par√¢metro (flex√≠vel, test√°vel)

### 6.3 Compatibilidade
- ‚úÖ **Cross-platform:** Suporta Windows (`\`) e Unix (`/`) paths
- ‚úÖ **Fallback:** guess_mime retorna "application/octet-stream" para tipos desconhecidos

### 6.4 Design Patterns
- ‚úÖ **Factory Pattern:** collect_pdf_items_from_folder e build_items_from_files recebem factory
- ‚úÖ **Callback Pattern:** prepare_folder_entries recebe hash_func
- ‚úÖ **Lazy Import:** build_remote_path importa client_prefix_for_id apenas quando necess√°rio

---

## 7. Commits Sugeridos

### 7.1 Commit: TEST-006

```bash
git add tests/unit/modules/uploads/test_uploads_validation_fase63.py \
  docs/releases/v1.4.72/TEST006_NOTAS_UPLOADS_VALIDATION.md \
  docs/releases/v1.4.72/CODEX_TEST006_2025-12-20.md

git commit -m "test: TEST-006 uploads/validation.py (35 tests, 100% pass)"
```

**Descri√ß√£o:**
```
[TEST-006] uploads/validation.py Tests (35 passed)

Created comprehensive test suite for modules/uploads/validation.py:
- ensure_existing_folder: 3 tests (valida√ß√£o, FileNotFoundError)
- iter_local_files: 3 tests (flat, recursive, empty)
- guess_mime: 4 tests (pdf, jpg, txt, fallback octet-stream)
- normalize_relative_path: 5 tests (backslash, path traversal, leading/trailing slash)
- prepare_folder_entries: 6 tests (metadados completos, hash_func, storage_key, empty folder)
- collect_pdf_items_from_folder: 5 tests (filtra PDFs, empty, nonexistent, sort)
- build_items_from_files: 4 tests (empty, filter, sort)
- build_remote_path: 5 tests (modo 1/2, subfolder, normaliza√ß√£o, path traversal)

Isolation techniques:
- tmp_path para criar arquivos reais tempor√°rios (pytest cleanup)
- fake_hash_func: lambda retornando "fake-sha256-hash"
- mock_storage_key_functions: make_storage_key, storage_slug_part, storage_slug_filename
- mock_client_prefix: lazy import de client_prefix_for_id

Security coverage:
- Path traversal sanitization (normalize_relative_path)
- Backslash normalization (cross-platform)
- MIME type fallback
- Valida√ß√£o de diret√≥rio existente

Coverage: 100% pass rate (35/35 tests in ~0.15s)
Edge cases: path traversal, empty folders, sorting, lazy imports

Related: PROMPT-CODEX v1.4.72 TEST-006 (2025-12-20)
```

---

## 8. Compara√ß√£o com Sess√µes Anteriores

### 8.1 Progress√£o do CODEX

| Sess√£o | M√≥dulo | Testes Criados | Pass Rate |
|--------|--------|----------------|-----------|
| TEST-001 | core/auth/auth.py | 25 | 100% |
| TEST-002 | utils/validators.py | +40 (114 total) | 100% |
| TEST-003 | core/services/clientes_service.py | 30 | 100% |
| TEST-004 | core/search/search.py | 35 | 100% |
| TEST-005 | modules/uploads/service.py | 31 | 100% |
| **TEST-006** | **modules/uploads/validation.py** | **35** | **100%** |

**Total acumulado:** 196 novos testes (TEST-001 a TEST-006)

### 8.2 Padr√£o de Qualidade Mantido

‚úÖ Isolamento com tmp_path + mocks  
‚úÖ Sem network real  
‚úÖ Sem global coverage (pytest apenas no arquivo novo)  
‚úÖ Fixtures reutiliz√°veis (fake_hash_func, mock_storage_key_functions)  
‚úÖ Edge cases documentados (path traversal, empty folders, sorting)  
‚úÖ Ruff + compileall passando (exceto E731 - lambdas aceit√°veis em factories)

---

## 9. Pr√≥ximos Passos

### 9.1 M√≥dulos Sugeridos (Prioridade)

**J√° cobertos:**
- ‚úÖ core/auth/auth.py (TEST-001)
- ‚úÖ utils/validators.py (TEST-002)
- ‚úÖ core/services/clientes_service.py (TEST-003)
- ‚úÖ core/search/search.py (TEST-004)
- ‚úÖ modules/uploads/service.py (TEST-005)
- ‚úÖ modules/uploads/validation.py (TEST-006)

**Pr√≥ximos candidatos (m√≥dulo uploads):**
- üîÑ modules/uploads/repository.py (upload_items_with_adapter, CRUD documents, insert_document_record)
- üîÑ modules/uploads/components/helpers.py (client_prefix_for_id, get_clients_bucket)

**Pr√≥ximos candidatos (outros m√≥dulos):**
- üîÑ core/db_manager/db_manager.py (list_clientes_by_org, CRUD b√°sico)
- üîÑ modules/auditoria/service.py (log de a√ß√µes)
- üîÑ modules/main_window/controller.py (17 testes j√° existem, expandir)

### 9.2 Recomenda√ß√µes

1. **Completar m√≥dulo uploads:** repository.py e helpers.py para fechar ciclo
2. **Focar em camadas cr√≠ticas:** Services > Repositories > Validation > Controllers
3. **Manter isolamento rigoroso:** Mocks completos, sem I/O real (exceto tmp_path quando necess√°rio)
4. **Documentar mapeamento:** Notas detalhadas antes de criar testes
5. **Priorizar seguran√ßa:** Verificar sanitiza√ß√£o de inputs em testes futuros

---

## 10. Checklist Final

- [x] Mapeamento: TEST006_NOTAS_UPLOADS_VALIDATION.md criado
- [x] Testes: test_uploads_validation_fase63.py criado (35 testes)
- [x] Execu√ß√£o: 100% pass rate (35/35 tests)
- [x] Sanidade: compileall passando
- [x] Sanidade: ruff check (F401 e F841 corrigidos, E731 lambdas aceit√°veis)
- [x] Documenta√ß√£o: CODEX_TEST006_2025-12-20.md
- [x] Commit sugerido: 1 commit com mensagem detalhada
- [x] Seguran√ßa: Verificado path traversal sanitization

**Status:** ‚úÖ **PROMPT-CODEX TEST-006 CONCLU√çDO COM SUCESSO**

---

**Assinatura:**  
GitHub Copilot (Claude Sonnet 4.5)  
RC Gestor v1.4.72 ‚Äî 2025-12-20
