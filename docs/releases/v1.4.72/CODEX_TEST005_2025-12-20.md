# CODEX_TEST005_2025-12-20.md

**RC Gestor v1.4.72 ‚Äî PROMPT-CODEX TEST-005**  
**Data:** 2025-12-20  
**Escopo:** Testes de src/modules/uploads/service.py  
**Resultado:** ‚úÖ **31 testes, 100% pass**

---

## 1. Mapeamento do M√≥dulo

### 1.1 Arquivo de Notas
**Criado:** [TEST005_NOTAS_UPLOADS.md](TEST005_NOTAS_UPLOADS.md)

### 1.2 API P√∫blica Identificada

**Fun√ß√µes principais:**
- `upload_folder_to_supabase(folder, client_id, subdir)` ‚Üí list[dict] (metadados)
- `upload_items_for_client(items, cnpj_digits, ...)` ‚Üí (success_count, errors_list)
- `download_and_open_file(remote_key, bucket, mode)` ‚Üí dict (ok/message/temp_path/error)
- `delete_storage_object(remote_key, bucket)` ‚Üí bool (sem exce√ß√£o)
- `delete_storage_folder(prefix, bucket)` ‚Üí dict (ok/deleted/errors/message)
- `download_storage_object(remote_key, destination, bucket)` ‚Üí dict (ok/errors/message/local_path)
- `list_browser_items(prefix, bucket)` ‚Üí Iterable

**Helpers:**
- `collect_pdfs_from_folder(dirpath)` ‚Üí list[UploadItem]
- `build_items_from_files(paths)` ‚Üí list[UploadItem]

### 1.3 Depend√™ncias Externas

- **Repository:** current_user_id, resolve_org_id, upload_items_with_adapter, insert_document_record, etc.
- **Validation:** ensure_existing_folder, prepare_folder_entries, collect_pdf_items_from_folder, etc.
- **Storage API:** delete_file, using_storage_backend, download_folder_zip
- **Temp Files:** create_temp_file
- **Sistema:** os.startfile (Windows), shutil.which + subprocess.Popen (macOS/Linux)

---

## 2. Su√≠te de Testes: test_uploads_service_fase62.py

### 2.1 Estat√≠sticas

**Arquivo:** `tests/unit/modules/uploads/test_uploads_service_fase62.py`  
**Linhas de c√≥digo:** 560 linhas  
**Total de testes:** 31 testes  
**Resultado:** ‚úÖ **31 passed (100%)**  
**Tempo de execu√ß√£o:** ~0.15s

### 2.2 Cobertura Funcional

#### A) `download_and_open_file` (9 testes - Prioridade ALTA)
- ‚úÖ `test_download_and_open_file_invalid_mode`: ValueError se mode inv√°lido
- ‚úÖ `test_download_and_open_file_internal_mode_success`: Mode "internal" retorna temp_path
- ‚úÖ `test_download_and_open_file_external_windows`: Windows usa os.startfile
- ‚úÖ `test_download_and_open_file_external_macos`: macOS usa shutil.which("open") + subprocess
- ‚úÖ `test_download_and_open_file_external_linux`: Linux usa shutil.which("xdg-open") + subprocess
- ‚úÖ `test_download_and_open_file_external_command_not_found`: Erro se comando n√£o encontrado
- ‚úÖ `test_download_and_open_file_download_fails`: Retorna erro se download falhar
- ‚úÖ `test_download_and_open_file_temp_creation_fails`: Erro ao criar temp file
- ‚úÖ `test_download_and_open_file_default_bucket`: Usa bucket padr√£o se n√£o fornecido

**T√©cnicas:**
- Mock de `sys.platform` para testar 3 SOs
- Mock de `shutil.which()` para resolver comandos
- Mock de `subprocess.Popen()` para abrir arquivo
- Mock de `os.startfile()` (Windows)
- Mock de `create_temp_file()` com tmp_path

#### B) `delete_storage_folder` (5 testes - Prioridade ALTA)
- ‚úÖ `test_delete_storage_folder_empty_prefix`: Retorna erro se prefix vazio
- ‚úÖ `test_delete_storage_folder_success`: Deleta todos os arquivos com sucesso
- ‚úÖ `test_delete_storage_folder_partial_failure`: Deleta o que conseguir, acumula erros
- ‚úÖ `test_delete_storage_folder_exception_on_delete`: Captura exce√ß√£o, continua
- ‚úÖ `test_delete_storage_folder_recursive`: Coleta arquivos recursivamente
- ‚úÖ `test_delete_storage_folder_empty_result`: Pasta vazia ‚Üí ok=True, deleted=0

**T√©cnicas:**
- Mock de `list_storage_objects()` com arquivos/pastas
- Mock de `_collect_storage_keys()` para recurs√£o
- Mock de `delete_file()` com side_effects variados
- Verifica√ß√£o de context manager `using_storage_backend`

#### C) `delete_storage_object` (3 testes - Prioridade M√âDIA)
- ‚úÖ `test_delete_storage_object_success`: Retorna True em sucesso
- ‚úÖ `test_delete_storage_object_failure`: Retorna False se delete_file retornar False
- ‚úÖ `test_delete_storage_object_exception`: Retorna False se exce√ß√£o, sem propagar

**T√©cnicas:**
- Mock de `delete_file()` com retornos True/False/Exception
- Verifica√ß√£o de que exce√ß√£o n√£o propaga

#### D) `upload_folder_to_supabase` (3 testes - Prioridade ALTA)
- ‚úÖ `test_upload_folder_to_supabase_success`: Retorna lista de metadados
- ‚úÖ `test_upload_folder_to_supabase_no_user`: RuntimeError se sem usu√°rio
- ‚úÖ `test_upload_folder_to_supabase_multiple_files`: Processa m√∫ltiplos arquivos

**T√©cnicas:**
- Mock de `repository.current_user_id()` ‚Üí None para testar auth
- Mock de `validation.prepare_folder_entries()` com entries fake
- Mock de `insert_document_record()` e `insert_document_version_record()`
- Verifica√ß√£o de chamadas com `assert_called_once()`

#### E) `upload_items_for_client` (3 testes - Prioridade M√âDIA)
- ‚úÖ `test_upload_items_for_client_success`: Retorna (success_count, [])
- ‚úÖ `test_upload_items_for_client_partial_errors`: Retorna (partial_count, errors)
- ‚úÖ `test_upload_items_for_client_progress_callback`: Callback passado para repository

**T√©cnicas:**
- Mock de `upload_items_with_adapter()` com retornos variados
- Cria√ß√£o de `UploadItem` objects
- Verifica√ß√£o de callback no call_kwargs

#### F) `list_browser_items` (3 testes - Prioridade BAIXA)
- ‚úÖ `test_list_browser_items_normalizes_prefix`: Normaliza prefix removendo "/"
- ‚úÖ `test_list_browser_items_uses_default_bucket`: Usa bucket padr√£o
- ‚úÖ `test_list_browser_items_uses_explicit_bucket`: Usa bucket expl√≠cito

**T√©cnicas:**
- Mock de `list_storage_objects()` (lazy import)
- Mock de `get_clients_bucket()`
- Verifica√ß√£o de chamadas com argumentos corretos

#### G) `download_storage_object` (2 testes - Prioridade BAIXA)
- ‚úÖ `test_download_storage_object_success`: Retorna ok=True
- ‚úÖ `test_download_storage_object_failure`: Retorna ok=False

**T√©cnicas:**
- Mock de `download_file()` (lazy import)
- Verifica√ß√£o de retorno dict

#### H) Helpers (2 testes - Prioridade BAIXA)
- ‚úÖ `test_collect_pdfs_from_folder_delegates`: Delega para validation
- ‚úÖ `test_build_items_from_files_delegates`: Delega para validation

**T√©cnicas:**
- Mock de `validation.collect_pdf_items_from_folder()`
- Mock de `validation.build_items_from_files()`

---

## 3. T√©cnicas de Isolamento

### 3.1 Sem Network/Storage Real
**Mocks de Repository:**
- `current_user_id()` ‚Üí "user-123" | None
- `resolve_org_id()` ‚Üí "org-456"
- `build_storage_adapter()` ‚Üí Mock adapter
- `upload_items_with_adapter()` ‚Üí (count, errors)
- `insert_document_record()` ‚Üí {"id": 1}

**Mocks de Storage API:**
- `delete_file()` ‚Üí True/False
- `using_storage_backend()` ‚Üí context manager mock
- `download_folder_zip()` ‚Üí Mock

### 3.2 Sem Filesystem Real
**Mock de Validation:**
- `ensure_existing_folder()` ‚Üí tmp_path
- `prepare_folder_entries()` ‚Üí lista de Mock entries
- `collect_pdf_items_from_folder()` ‚Üí lista de UploadItem

**Mock de Temp Files:**
- `create_temp_file()` ‚Üí Mock com .path = "/tmp/file.pdf"

### 3.3 Sem Subprocess Real
**Mock de Sistema Operacional:**
- `sys.platform` ‚Üí "win32" | "darwin" | "linux" (monkeypatch)
- `os.startfile()` ‚Üí Mock (Windows)
- `shutil.which()` ‚Üí "/usr/bin/open" | "/usr/bin/xdg-open" | None
- `subprocess.Popen()` ‚Üí Mock process

### 3.4 Lazy Imports
**Mock de m√≥dulos lazy-imported:**
- `src.modules.forms.view.download_file()` ‚Üí {"ok": True, ...}
- `src.modules.forms.view.list_storage_objects()` ‚Üí [{"full_path": ...}]

### 3.5 Fixtures Reutiliz√°veis
- `mock_repository`: Mock completo do repository (10 fun√ß√µes)
- `mock_validation`: Mock completo do validation (5 fun√ß√µes)
- `mock_storage_api`: Mock de delete_file + using_storage_backend
- `mock_temp_files`: Mock de create_temp_file
- `mock_download_file`: Mock de download_file (lazy import)
- `mock_list_storage_objects`: Mock de list_storage_objects (lazy import)
- `mock_helpers`: Mock de get_clients_bucket + get_current_org_id

---

## 4. Sanidade: Compileall + Ruff

### 4.1 Compileall (Syntax Check)

```bash
python -m compileall src/modules/uploads/service.py tests/unit/modules/uploads/test_uploads_service_fase62.py
```

**Resultado:** ‚úÖ Ambos compilam sem erros de sintaxe.

### 4.2 Ruff (Linter)

```bash
python -m ruff check src/modules/uploads/service.py tests/unit/modules/uploads/test_uploads_service_fase62.py
```

**Resultado inicial:** 2 erros (F401 - imports n√£o usados: `Any`, `call`)

**Corre√ß√£o:**
```bash
python -m ruff check tests/unit/modules/uploads/test_uploads_service_fase62.py --fix
```

**Resultado final:** ‚úÖ 0 erros (2 fixed)

**Verifica√ß√£o p√≥s-fix:**
```bash
pytest -q tests/unit/modules/uploads/test_uploads_service_fase62.py
```
**Resultado:** ‚úÖ 31 passed (sem regress√£o)

---

## 5. Edge Cases Cobertos

### 5.1 Multiplataforma (download_and_open_file)
- ‚úÖ Windows: `os.startfile()` chamado diretamente
- ‚úÖ macOS: `shutil.which("open")` + `subprocess.Popen(["/usr/bin/open", path])`
- ‚úÖ Linux: `shutil.which("xdg-open")` + `subprocess.Popen(["/usr/bin/xdg-open", path])`
- ‚ö†Ô∏è Comando n√£o encontrado: `shutil.which()` retorna None ‚Üí erro trat√°vel

### 5.2 Modo de Abertura (download_and_open_file)
- ‚úÖ Mode "external": abre no viewer do SO
- ‚úÖ Mode "internal": retorna temp_path para caller (PDF preview)
- ‚ùå Mode inv√°lido: `ValueError`

### 5.3 Falhas Parciais (delete_storage_folder)
- ‚úÖ Alguns arquivos falham: `ok=False`, `deleted=partial`, `errors` preenchido
- ‚úÖ Exce√ß√£o ao deletar: captura, acumula erro, continua
- ‚úÖ Pasta vazia: `ok=True`, `deleted=0`

### 5.4 Autentica√ß√£o (upload_folder_to_supabase)
- ‚ùå Usu√°rio n√£o autenticado: `RuntimeError("Usuario nao autenticado...")`
- ‚úÖ Usu√°rio autenticado: processa normalmente

### 5.5 Error Handling Sem Exce√ß√£o
- ‚úÖ `delete_storage_object()`: retorna False, nunca levanta exce√ß√£o
- ‚úÖ `delete_storage_folder()`: retorna dict com ok=False + errors, nunca levanta exce√ß√£o
- ‚úÖ `download_and_open_file()`: retorna dict com ok=False + error, nunca levanta exce√ß√£o (exceto ValueError para mode inv√°lido)

### 5.6 Normaliza√ß√£o de Paths
- ‚úÖ `list_browser_items()`: strip "/" do prefix antes de listar
- ‚úÖ Bucket padr√£o vs expl√≠cito: usa `get_clients_bucket()` ou bucket fornecido

---

## 6. Observa√ß√µes de Seguran√ßa

### 6.1 Subprocess Safety
- ‚úÖ **shutil.which()** sempre usado para resolver comandos (evita PATH injection)
- ‚úÖ **subprocess.Popen()** com array de args, NUNCA `shell=True`
- ‚úÖ **os.startfile()** usa path controlado pelo app, n√£o input externo
- ‚úÖ Markers `# nosec B404, B606, B603` documentam uso seguro

### 6.2 Testes de Seguran√ßa
- ‚úÖ Verificado que `shutil.which()` √© chamado antes de subprocess
- ‚úÖ Verificado que `subprocess.Popen()` recebe array `[cmd, path]`, n√£o string
- ‚úÖ Testado cen√°rio onde comando n√£o √© encontrado (None)

---

## 7. Commits Sugeridos

### 7.1 Commit: TEST-005

```bash
git add tests/unit/modules/uploads/test_uploads_service_fase62.py \
  docs/releases/v1.4.72/TEST005_NOTAS_UPLOADS.md \
  docs/releases/v1.4.72/CODEX_TEST005_2025-12-20.md

git commit -m "test: TEST-005 uploads/service.py (31 tests, 100% pass)"
```

**Descri√ß√£o:**
```
[TEST-005] uploads/service.py Tests (31 passed)

Created comprehensive test suite for modules/uploads/service.py:
- download_and_open_file: 9 tests (3 platforms, 2 modes, error paths)
- delete_storage_folder: 6 tests (recurs√£o, parcial ok, edge cases)
- delete_storage_object: 3 tests (error handling sem exce√ß√£o)
- upload_folder_to_supabase: 3 tests (auth check, m√∫ltiplos arquivos)
- upload_items_for_client: 3 tests (callback, partial errors)
- list_browser_items: 3 tests (normaliza√ß√£o, bucket padr√£o/expl√≠cito)
- download_storage_object: 2 tests (wrapper ok/failure)
- Helpers: 2 tests (collect_pdfs, build_items)

Isolation techniques:
- Mocked repository (current_user_id, resolve_org_id, upload_items_with_adapter)
- Mocked validation (ensure_existing_folder, prepare_folder_entries)
- Mocked storage API (delete_file, using_storage_backend)
- Mocked system (sys.platform, os.startfile, shutil.which, subprocess.Popen)
- Mocked lazy imports (download_file, list_storage_objects)
- No network, no FS, no subprocess (all mocks)

Coverage: 100% pass rate (31/31 tests in ~0.15s)
Security: Verified shutil.which() + subprocess.Popen() safe usage
Edge cases: multiplataforma, mode validation, partial failures, auth check

Related: PROMPT-CODEX v1.4.72 TEST-005 (2025-12-20)
```

---

## 8. Compara√ß√£o com Sess√µes Anteriores

### 8.1 Progress√£o do CODEX

| Sess√£o | M√≥dulo | Testes Criados | Pass Rate |
|--------|--------|----------------|-----------|
| TEST-001 | core/auth/auth.py | 25 | 100% |
| TEST-002 | utils/validators.py | +40 (114 total) | 100% |
| TEST-003 | core/services/clientes_service.py | 30 | 100% |
| TEST-004 | core/search/search.py | 35 | 100% |
| **TEST-005** | **modules/uploads/service.py** | **31** | **100%** |

**Total acumulado:** 161 novos testes (TEST-001 a TEST-005)

### 8.2 Padr√£o de Qualidade Mantido

‚úÖ Sem network real (mocks de Storage API)  
‚úÖ Sem database real (mocks de repository)  
‚úÖ Sem FS real (tmp_path + mocks)  
‚úÖ Sem subprocess real (mocks de shutil.which + Popen)  
‚úÖ Sem global coverage (pytest apenas no arquivo novo)  
‚úÖ Isolamento completo (fixtures reutiliz√°veis)  
‚úÖ Edge cases documentados  
‚úÖ Ruff + compileall passando

---

## 9. Pr√≥ximos Passos

### 9.1 M√≥dulos Sugeridos (Prioridade)

**J√° cobertos:**
- ‚úÖ core/auth/auth.py (TEST-001)
- ‚úÖ utils/validators.py (TEST-002)
- ‚úÖ core/services/clientes_service.py (TEST-003)
- ‚úÖ core/search/search.py (TEST-004)
- ‚úÖ modules/uploads/service.py (TEST-005)

**Pr√≥ximos candidatos:**
- üîÑ modules/uploads/validation.py (valida√ß√µes de upload, prepare_folder_entries)
- üîÑ modules/uploads/repository.py (upload_items_with_adapter, CRUD documents)
- üîÑ core/db_manager/db_manager.py (list_clientes_by_org, CRUD b√°sico)
- üîÑ modules/auditoria/service.py (log de a√ß√µes)
- üîÑ modules/main_window/controller.py (17 testes j√° existem, expandir)

### 9.2 Recomenda√ß√µes

1. **Continuar padr√£o CODEX:** Mapear ‚Üí Criar testes ‚Üí Sanidade ‚Üí Relat√≥rio
2. **Focar em camadas cr√≠ticas:** Services > Repositories > Validation > Controllers
3. **Manter isolamento rigoroso:** Mocks completos, sem I/O real
4. **Documentar mapeamento:** Notas detalhadas antes de criar testes
5. **Priorizar seguran√ßa:** Verificar subprocess safety em testes futuros

---

## 10. Checklist Final

- [x] Mapeamento: TEST005_NOTAS_UPLOADS.md criado
- [x] Testes: test_uploads_service_fase62.py criado (31 testes)
- [x] Execu√ß√£o: 100% pass rate (31/31 tests)
- [x] Sanidade: compileall passando
- [x] Sanidade: ruff check (2 erros corrigidos, 0 remanescentes)
- [x] Documenta√ß√£o: CODEX_TEST005_2025-12-20.md
- [x] Commit sugerido: 1 commit com mensagem detalhada
- [x] Seguran√ßa: Verificado subprocess safety (shutil.which + Popen)

**Status:** ‚úÖ **PROMPT-CODEX TEST-005 CONCLU√çDO COM SUCESSO**

---

**Assinatura:**  
GitHub Copilot (Claude Sonnet 4.5)  
RC Gestor v1.4.72 ‚Äî 2025-12-20
