# CODEX_TEST004_2025-12-20.md

**RC Gestor v1.4.72 ‚Äî PROMPT-CODEX TEST-004**  
**Data:** 2025-12-20  
**Escopo:** Testes de src/core/search/search.py  
**Resultado:** ‚úÖ **35 testes, 100% pass**

---

## 1. Mapeamento do M√≥dulo

### 1.1 Arquivo de Notas
**Criado:** [TEST004_NOTAS_SEARCH.md](TEST004_NOTAS_SEARCH.md)

### 1.2 API P√∫blica Identificada

**Fun√ß√£o principal:**
- `search_clientes(term, order_by, org_id)` ‚Üí `list[Cliente]`
  - Online: consulta Supabase com filtro ilike + filtro local duplo
  - Offline: fallback para `list_clientes_by_org()` + filtro local
  - Exige `org_id` (auto-resolve de `get_current_user()` se None)

**Fun√ß√µes auxiliares:**
- `_normalize_order(order_by)` ‚Üí `(column: str | None, descending: bool)`
- `_row_to_cliente(row)` ‚Üí `Cliente`
- `_cliente_search_blob(cliente)` ‚Üí `str` (concatena√ß√£o normalizada)
- `_filter_rows_with_norm(rows, term)` ‚Üí `list[dict]` (filtro local com cache)
- `_filter_clientes(clientes, term)` ‚Üí `list[Cliente]` (filtro em objetos)

### 1.3 Depend√™ncias Externas

- `infra.supabase_client` (is_supabase_online, exec_postgrest, supabase.table)
- `src.core.db_manager.db_manager` (list_clientes_by_org, CLIENT_COLUMNS)
- `src.core.session.session` (get_current_user)
- `src.core.textnorm` (normalize_search, join_and_normalize)
- `src.core.models` (Cliente)

---

## 2. Su√≠te de Testes: test_search_fase61.py

### 2.1 Estat√≠sticas

**Arquivo:** `tests/unit/core/search/test_search_fase61.py`  
**Linhas de c√≥digo:** 555 linhas  
**Total de testes:** 35 testes  
**Resultado:** ‚úÖ **35 passed (100%)**  
**Tempo de execu√ß√£o:** ~0.15s

### 2.2 Cobertura Funcional

#### A) `_normalize_order` (6 testes)
- ‚úÖ `test_normalize_order_nome`: Mapeia "nome" ‚Üí ("nome", False)
- ‚úÖ `test_normalize_order_razao_social_variations`: Aceita "razao social" e "razao_social"
- ‚úÖ `test_normalize_order_ultima_alteracao_descending`: "ultima alteracao" ‚Üí descending=True
- ‚úÖ `test_normalize_order_case_insensitive`: Case-insensitive
- ‚úÖ `test_normalize_order_invalid`: Retorna (None, False) para apelido inv√°lido
- ‚úÖ `test_normalize_order_none`: Retorna (None, False) para None

#### B) `_row_to_cliente` (3 testes)
- ‚úÖ `test_row_to_cliente_all_fields`: Converte row completa em Cliente
- ‚úÖ `test_row_to_cliente_missing_fields`: Campos ausentes ‚Üí None
- ‚úÖ `test_row_to_cliente_empty_row`: Row vazia ‚Üí Cliente com todos None

#### C) `_cliente_search_blob` (2 testes)
- ‚úÖ `test_cliente_search_blob_all_fields`: Concatena id, nome, razao, cnpj, numero, obs
- ‚úÖ `test_cliente_search_blob_partial_fields`: Lida com campos parciais

#### D) `_filter_rows_with_norm` (4 testes)
- ‚úÖ `test_filter_rows_with_norm_match`: Retorna rows que cont√™m termo normalizado
- ‚úÖ `test_filter_rows_with_norm_empty_term`: Termo vazio ‚Üí todas as rows
- ‚úÖ `test_filter_rows_with_norm_caching`: Cacheia _search_norm nas rows
- ‚úÖ `test_filter_rows_with_norm_no_match`: Retorna vazio se nenhum match

#### E) `_filter_clientes` (3 testes)
- ‚úÖ `test_filter_clientes_match`: Retorna clientes que cont√™m termo
- ‚úÖ `test_filter_clientes_empty_term`: Termo vazio ‚Üí todos os clientes
- ‚úÖ `test_filter_clientes_no_match`: Retorna vazio se nenhum match

#### F) `search_clientes` - Online (7 testes)
- ‚úÖ `test_search_clientes_online_basic`: Retorna clientes quando online e com resultados
- ‚úÖ `test_search_clientes_online_empty_term`: Termo vazio ‚Üí todos da org
- ‚úÖ `test_search_clientes_online_with_order`: Aplica ordena√ß√£o via order()
- ‚úÖ `test_search_clientes_online_no_org_id_raises`: ValueError se org_id=None
- ‚úÖ `test_search_clientes_online_auto_resolve_org_id`: Auto-resolve de get_current_user()
- ‚úÖ `test_search_clientes_online_double_filter`: 2 queries se 1¬™ vazia (com termo)
- ‚úÖ `test_search_clientes_supabase_exception_no_org_id_raises`: Exce√ß√£o + org_id=None ‚Üí ValueError

#### G) `search_clientes` - Offline/Fallback (6 testes)
- ‚úÖ `test_search_clientes_offline`: Usa list_clientes_by_org quando offline
- ‚úÖ `test_search_clientes_offline_no_org_id_raises`: ValueError se org_id=None
- ‚úÖ `test_search_clientes_supabase_exception_fallback`: Exce√ß√£o ‚Üí fallback local
- ‚úÖ `test_search_clientes_offline_with_order`: Passa order_by + descending corretos
- ‚úÖ `test_search_clientes_offline_empty_term`: Termo vazio ‚Üí todos os clientes
- ‚úÖ `test_search_clientes_offline_filter_local`: Aplica filtro local quando termo fornecido

#### H) `search_clientes` - Edge Cases (4 testes)
- ‚úÖ `test_search_clientes_term_whitespace_only`: Termo apenas espa√ßos ‚Üí trata como vazio
- ‚úÖ `test_search_clientes_order_by_invalid`: order_by inv√°lido ‚Üí n√£o chama order()
- ‚úÖ `test_search_clientes_empty_response`: response.data=None ‚Üí lista vazia
- ‚úÖ `test_search_clientes_current_user_no_org_id`: current_user sem org_id ‚Üí ValueError

---

## 3. T√©cnicas de Isolamento

### 3.1 Sem Network Real
**Mocks de Supabase:**
- `is_supabase_online()` ‚Üí retorna True/False (controla online/offline)
- `exec_postgrest()` ‚Üí retorna Mock com .data
- `supabase.table()` ‚Üí retorna Mock QueryBuilder encadeado (select, is_, eq, or_, order)

### 3.2 Sem Database Real
**Mock de reposit√≥rio local:**
- `src.core.db_manager.db_manager.list_clientes_by_org()` ‚Üí lista fake de Cliente

### 3.3 Sem Sess√£o Real
**Mock de usu√°rio:**
- `get_current_user()` ‚Üí retorna Mock com .org_id

### 3.4 Fixtures Reutiliz√°veis
- `mock_supabase_online`: Controla is_supabase_online()
- `mock_supabase_client`: Mock completo com QueryBuilder encadeado
- `mock_db_manager`: Mock de list_clientes_by_org
- `mock_current_user`: Mock de get_current_user com org_id

---

## 4. Sanidade: Compileall + Ruff

### 4.1 Compileall (Syntax Check)

```bash
python -m compileall src/core/search/search.py tests/unit/core/search/test_search_fase61.py
```

**Resultado:** ‚úÖ Ambos compilam sem erros de sintaxe.

### 4.2 Ruff (Linter)

```bash
python -m ruff check src/core/search/search.py tests/unit/core/search/test_search_fase61.py
```

**Resultado inicial:** 2 erros (F401 - imports n√£o usados: `MagicMock`, `call`)

**Corre√ß√£o:**
```bash
python -m ruff check tests/unit/core/search/test_search_fase61.py --fix
```

**Resultado final:** ‚úÖ 0 erros (2 fixed)

**Verifica√ß√£o p√≥s-fix:**
```bash
pytest -q tests/unit/core/search/test_search_fase61.py
```
**Resultado:** ‚úÖ 35 passed (sem regress√£o)

---

## 5. Edge Cases Cobertos

### 5.1 Duplo Filtro Online
- Primeira query com `ilike` retorna vazio
- Segunda query sem filtro + reaplica filtro local
- Garante m√°xima recall mesmo com normaliza√ß√µes diferentes

### 5.2 ValueError Consistente
- Online sem org_id ‚Üí ValueError
- Offline sem org_id ‚Üí ValueError
- Exce√ß√£o Supabase sem org_id ‚Üí ValueError
- current_user sem org_id ‚Üí ValueError

### 5.3 Normaliza√ß√£o de Ordena√ß√£o
- Case-insensitive: "NOME" ‚Üí "nome"
- Apelidos: "razao social" ‚Üí "razao_social"
- Descending autom√°tico: "ultima alteracao" ‚Üí desc=True
- Inv√°lido: "campo_invalido" ‚Üí (None, False)

### 5.4 Cacheamento
- `_filter_rows_with_norm()` adiciona `_search_norm` nas rows
- Evita rec√°lculo de normaliza√ß√£o em m√∫ltiplas filtragens

### 5.5 Fallback Silencioso
- Exce√ß√£o do Supabase ‚Üí log.warning + fallback
- N√£o propaga exce√ß√£o se fallback bem-sucedido

---

## 6. Commits Sugeridos

### 6.1 Commit: TEST-004

```bash
git add tests/unit/core/search/test_search_fase61.py docs/releases/v1.4.72/TEST004_NOTAS_SEARCH.md docs/releases/v1.4.72/CODEX_TEST004_2025-12-20.md
git commit -m "test: TEST-004 search.py (35 tests, 100% pass)"
```

**Descri√ß√£o:**
```
[TEST-004] search.py Tests (35 passed)

Created comprehensive test suite for core/search/search.py:
- _normalize_order: 6 tests (mapeamento apelidos, case-insensitive)
- _row_to_cliente: 3 tests (convers√£o row‚ÜíCliente, campos ausentes)
- _cliente_search_blob: 2 tests (concatena√ß√£o normalizada)
- _filter_rows_with_norm: 4 tests (filtro local, caching _search_norm)
- _filter_clientes: 3 tests (filtro em lista de Cliente)
- search_clientes online: 7 tests (Supabase, ordena√ß√£o, org_id, duplo filtro)
- search_clientes offline: 6 tests (fallback local, org_id, ordena√ß√£o)
- Edge cases: 4 tests (whitespace, response.data=None, ValueError)

Isolation techniques:
- Mocked infra.supabase_client (is_supabase_online, exec_postgrest, QueryBuilder)
- Mocked db_manager.list_clientes_by_org (fallback local)
- Mocked get_current_user (auto-resolve org_id)
- No network, no database (all mocks)

Coverage: 100% pass rate (35/35 tests in ~0.15s)
Edge cases: duplo filtro online, ValueError consistente, cacheamento _search_norm

Related: PROMPT-CODEX v1.4.72 TEST-004 (2025-12-20)
```

---

## 7. Compara√ß√£o com Sess√µes Anteriores

### 7.1 Progress√£o do CODEX

| Sess√£o | M√≥dulo | Testes Criados | Pass Rate |
|--------|--------|----------------|-----------|
| TEST-001 | core/auth/auth.py | 25 | 100% |
| TEST-002 | utils/validators.py | +40 (114 total) | 100% |
| TEST-003 | core/services/clientes_service.py | 30 | 100% |
| **TEST-004** | **core/search/search.py** | **35** | **100%** |

**Total acumulado:** 130 novos testes (TEST-001 a TEST-004)

### 7.2 Padr√£o de Qualidade Mantido

‚úÖ Sem network real (mocks de Supabase)  
‚úÖ Sem database real (mocks de db_manager)  
‚úÖ Sem global coverage (pytest apenas no arquivo novo)  
‚úÖ Isolamento completo (tmp_path, monkeypatch)  
‚úÖ Edge cases documentados  
‚úÖ Ruff + compileall passando

---

## 8. Pr√≥ximos Passos

### 8.1 M√≥dulos Sugeridos (Prioridade ALTA)

Ap√≥s TEST-004, considerar:

**J√° cobertos:**
- ‚úÖ core/auth/auth.py (TEST-001)
- ‚úÖ utils/validators.py (TEST-002)
- ‚úÖ core/services/clientes_service.py (TEST-003)
- ‚úÖ core/search/search.py (TEST-004)

**Pr√≥ximos candidatos:**
- üîÑ modules/uploads/service.py (QA-004 completo, testes pending)
- üîÑ core/db_manager/db_manager.py (CRUD b√°sico, list_clientes_by_org)
- üîÑ modules/auditoria/service.py (log de a√ß√µes)
- üîÑ modules/main_window/controller.py (17 testes j√° existem, expandir?)

### 8.2 Recomenda√ß√µes

1. **Continuar padr√£o CODEX:** Mapear ‚Üí Criar testes ‚Üí Sanidade ‚Üí Relat√≥rio
2. **Focar em camadas:** Services > Repositories > Controllers
3. **Manter isolamento rigoroso:** Mocks completos, sem I/O real
4. **Documentar mapeamento:** Notas detalhadas antes de criar testes

---

## 9. Checklist Final

- [x] Mapeamento: TEST004_NOTAS_SEARCH.md criado
- [x] Testes: test_search_fase61.py criado (35 testes)
- [x] Execu√ß√£o: 100% pass rate (35/35 tests)
- [x] Sanidade: compileall passando
- [x] Sanidade: ruff check (2 erros corrigidos, 0 remanescentes)
- [x] Documenta√ß√£o: CODEX_TEST004_2025-12-20.md
- [x] Commit sugerido: 1 commit com mensagem detalhada

**Status:** ‚úÖ **PROMPT-CODEX TEST-004 CONCLU√çDO COM SUCESSO**

---

**Assinatura:**  
GitHub Copilot (Claude Sonnet 4.5)  
RC Gestor v1.4.72 ‚Äî 2025-12-20
