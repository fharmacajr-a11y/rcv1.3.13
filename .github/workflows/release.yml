name: RC - release

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  release:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -U pyinstaller pytest

      - name: Run tests
        run: pytest -q

      - name: Build with PyInstaller
        run: pyinstaller build/rc_gestor.spec --clean

      - name: Verify build output
        run: |
          if (Test-Path dist\RC-Gestor\RC-Gestor.exe) {
            Write-Host "‚úì RC-Gestor.exe criado com sucesso"
            $size = (Get-Item dist\RC-Gestor\RC-Gestor.exe).Length / 1MB
            Write-Host "  Tamanho: $([math]::Round($size, 2)) MB"
          } else {
            Write-Error "‚úó RC-Gestor.exe n√£o encontrado!"
            exit 1
          }

      - name: Check for .env in bundle
        run: |
          $envFiles = Get-ChildItem -Path dist\RC-Gestor\ -Recurse -File | Where-Object {$_.Extension -eq '.env'}
          if ($envFiles) {
            Write-Error "‚úó Arquivos .env encontrados no bundle!"
            $envFiles | ForEach-Object { Write-Host $_.FullName }
            exit 1
          } else {
            Write-Host "‚úì Nenhum arquivo .env no bundle (seguro)"
          }

      - name: Zip artifact
        run: |
          Compress-Archive -Path dist\RC-Gestor\* -DestinationPath RC-Gestor-${{ github.ref_name }}.zip -Force
          $zipSize = (Get-Item RC-Gestor-${{ github.ref_name }}.zip).Length / 1MB
          Write-Host "‚úì ZIP criado: $([math]::Round($zipSize, 2)) MB"

      - name: Generate checksums
        run: |
          $hash = (Get-FileHash RC-Gestor-${{ github.ref_name }}.zip -Algorithm SHA256).Hash
          Write-Host "SHA256: $hash"
          "SHA256: $hash" | Out-File -FilePath RC-Gestor-${{ github.ref_name }}.zip.sha256

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            RC-Gestor-${{ github.ref_name }}.zip
            RC-Gestor-${{ github.ref_name }}.zip.sha256
          body: |
            ## RC-Gestor ${{ github.ref_name }}

            ### üì¶ Artefatos
            - `RC-Gestor-${{ github.ref_name }}.zip` - Build completo do Windows
            - `RC-Gestor-${{ github.ref_name }}.zip.sha256` - Checksum SHA256

            ### üìã Changelog
            Veja [LOG.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/docs/CLAUDE-SONNET-v1.0.29/LOG.md) para detalhes das mudan√ßas.

            ### ‚úÖ Verifica√ß√µes
            - ‚úì Testes passaram (pytest)
            - ‚úì Build seguro (sem .env)
            - ‚úì PyInstaller 6.16.0
            - ‚úì Python 3.13

            ### üîê Verifica√ß√£o de Integridade
            ```bash
            # Windows (PowerShell)
            (Get-FileHash RC-Gestor-${{ github.ref_name }}.zip -Algorithm SHA256).Hash

            # Linux/macOS
            sha256sum RC-Gestor-${{ github.ref_name }}.zip
            ```

            Compare com o hash no arquivo `.sha256`.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
