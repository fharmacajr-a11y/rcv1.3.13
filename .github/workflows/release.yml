name: RC - release

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  release:
    runs-on: windows-latest

    env:
      # FASE 6: For√ßa UTF-8 em todos os processos Python
      PYTHONUTF8: 1
      PYTHONIOENCODING: utf-8

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necess√°rio para hist√≥rico completo

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install -U pyinstaller

      - name: Verify encoding configuration
        run: |
          python -X utf8 -c "import sys; print(f'Default encoding: {sys.getdefaultencoding()}'); print(f'Filesystem encoding: {sys.getfilesystemencoding()}'); print(f'stdout encoding: {sys.stdout.encoding}')"

      - name: Run pre-commit hooks
        run: pre-commit run --all-files --show-diff-on-failure

      - name: Run Bandit security scan
        run: python -X utf8 -m bandit -c .bandit -r src infra adapters data security

      - name: Run tests (ClientesV2 suite)
        run: pytest tests/modules/clientes_v2/ -v --tb=short --maxfail=5

      - name: Run quick test suite
        run: pytest -q

      - name: Build with PyInstaller
        run: pyinstaller rcgestor.spec --clean

      - name: Verify build output
        run: |
          if (Test-Path dist\RC-Gestor\RC-Gestor.exe) {
            Write-Host "‚úì RC-Gestor.exe criado com sucesso"
            $size = (Get-Item dist\RC-Gestor\RC-Gestor.exe).Length / 1MB
            Write-Host "  Tamanho: $([math]::Round($size, 2)) MB"
          } else {
            Write-Error "‚úó RC-Gestor.exe n√£o encontrado!"
            exit 1
          }

      - name: Check for .env in bundle
        run: |
          $envFiles = Get-ChildItem -Path dist\RC-Gestor\ -Recurse -File | Where-Object {$_.Extension -eq '.env'}
          if ($envFiles) {
            Write-Error "‚úó Arquivos .env encontrados no bundle!"
            $envFiles | ForEach-Object { Write-Host $_.FullName }
            exit 1
          } else {
            Write-Host "‚úì Nenhum arquivo .env no bundle (seguro)"
          }

      - name: Zip artifact
        run: |
          Compress-Archive -Path dist\RC-Gestor\* -DestinationPath RC-Gestor-${{ github.ref_name }}.zip -Force
          $zipSize = (Get-Item RC-Gestor-${{ github.ref_name }}.zip).Length / 1MB
          Write-Host "‚úì ZIP criado: $([math]::Round($zipSize, 2)) MB"

      - name: Generate checksums
        run: |
          $hash = (Get-FileHash RC-Gestor-${{ github.ref_name }}.zip -Algorithm SHA256).Hash
          Write-Host "SHA256: $hash"
          "SHA256: $hash" | Out-File -FilePath RC-Gestor-${{ github.ref_name }}.zip.sha256

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            RC-Gestor-${{ github.ref_name }}.zip
            RC-Gestor-${{ github.ref_name }}.zip.sha256
            docs/FASE_5_RELEASE.md
          body: |
            ## RC-Gestor ${{ github.ref_name }}

            ### üì¶ Artefatos
            - `RC-Gestor-${{ github.ref_name }}.zip` - Build completo do Windows
            - `RC-Gestor-${{ github.ref_name }}.zip.sha256` - Checksum SHA256
            - `FASE_5_RELEASE.md` - Documenta√ß√£o da release

            ### üìã Changelog
            Veja [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/CHANGELOG.md) para detalhes das mudan√ßas.

            ### ‚úÖ Verifica√ß√µes (FASE 6)
            - ‚úì Pre-commit hooks (all-files)
            - ‚úì Bandit security scan
            - ‚úì ClientesV2 suite (113 testes)
            - ‚úì Encoding UTF-8 (Windows)
            - ‚úì Build seguro (sem .env)
            - ‚úì PyInstaller 6.16.0
            - ‚úì Python 3.13

            ### üîê Verifica√ß√£o de Integridade
            ```bash
            # Windows (PowerShell)
            (Get-FileHash RC-Gestor-${{ github.ref_name }}.zip -Algorithm SHA256).Hash

            # Linux/macOS
            sha256sum RC-Gestor-${{ github.ref_name }}.zip
            ```

            Compare com o hash no arquivo `.sha256`.

            ### üìù Tag Anotada
            Esta release foi gerada automaticamente a partir de uma tag anotada.
            Para criar tags anotadas:
            ```bash
            git tag -a v1.5.63 -m "Release v1.5.63 - FASE 6 CI/CD"
            git push origin v1.5.63
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
