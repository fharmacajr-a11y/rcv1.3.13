# RC Clientes ? Invent?rio (Passo 0)

_Gerado em 2025-11-19T04:23:49_

## 1. Top 150 arquivos .py por linhas

| # | Caminho | Linhas |
|---|---------|--------|
| 1 | `src/ui/files_browser.py` | 1491 |
| 2 | `src/modules/clientes/views/main_screen.py` | 1263 |
| 3 | `src/modules/main_window/views/main_window.py` | 930 |
| 4 | `src/modules/pdf_preview/views/main_window.py` | 878 |
| 5 | `src/modules/clientes/forms/pipeline.py` | 814 |
| 6 | `src/modules/hub/views/hub_screen.py` | 773 |
| 7 | `src/modules/hub/controller.py` | 542 |
| 8 | `src/modules/passwords/views/passwords_screen.py` | 515 |
| 9 | `src/modules/auditoria/views/main_frame.py` | 501 |
| 10 | `src/modules/hub/actions.py` | 437 |
| 11 | `src/ui/forms/actions.py` | 433 |
| 12 | `data/supabase_repo.py` | 424 |
| 13 | `src/modules/lixeira/views/lixeira.py` | 420 |
| 14 | `src/core/services/notes_service.py` | 379 |
| 15 | `src/core/db_manager/db_manager.py` | 368 |
| 16 | `src/modules/auditoria/views/upload_flow.py` | 341 |
| 17 | `src/modules/auditoria/archives.py` | 340 |
| 18 | `uploader_supabase.py` | 339 |
| 19 | `src/modules/clientes/forms/client_form.py` | 339 |
| 20 | `src/modules/clientes/service.py` | 332 |
| 21 | `src/ui/dialogs/storage_uploader.py` | 327 |
| 22 | `src/features/cashflow/ui.py` | 326 |
| 23 | `src/app_core.py` | 321 |
| 24 | `src/modules/auditoria/service.py` | 319 |
| 25 | `infra/supabase/db_client.py` | 318 |
| 26 | `src/modules/clientes/viewmodel.py` | 303 |
| 27 | `src/modules/cashflow/views/fluxo_caixa_frame.py` | 283 |
| 28 | `src/modules/clientes/forms/client_picker.py` | 278 |
| 29 | `tests/test_archives.py` | 277 |
| 30 | `scripts/test_progress_e2e.py` | 268 |
| 31 | `infra/supabase/storage_client.py` | 265 |
| 32 | `src/modules/auditoria/viewmodel.py` | 264 |
| 33 | `tests/test_file_select.py` | 258 |
| 34 | `src/core/commands.py` | 254 |
| 35 | `scripts/test_busca_robusta.py` | 249 |
| 36 | `src/utils/file_utils/bytes_utils.py` | 247 |
| 37 | `src/ui/widgets/autocomplete_entry.py` | 243 |
| 38 | `src/core/services/clientes_service.py` | 243 |
| 39 | `src/utils/validators.py` | 242 |
| 40 | `src/modules/uploads/views/browser.py` | 241 |
| 41 | `tests/test_clientes_integration.py` | 240 |
| 42 | `tests/test_health_fallback.py` | 239 |
| 43 | `src/modules/main_window/controller.py` | 233 |
| 44 | `src/modules/auditoria/views/dialogs.py` | 230 |
| 45 | `devtools/qa/analyze_supabase_errors.py` | 230 |
| 46 | `src/modules/uploads/service.py` | 229 |
| 47 | `src/utils/text_utils.py` | 222 |
| 48 | `adapters/storage/supabase_storage.py` | 221 |
| 49 | `src/app_gui.py` | 220 |
| 50 | `scripts/validate_7z_support.py` | 219 |
| 51 | `src/core/auth/auth.py` | 213 |
| 52 | `src/ui/login/login.py` | 212 |
| 53 | `devtools/arch/analyze_modules.py` | 212 |
| 54 | `infra/archive_utils.py` | 211 |
| 55 | `scripts/test_upload_advanced.py` | 205 |
| 56 | `src/ui/components/misc.py` | 202 |
| 57 | `src/features/cashflow/repository.py` | 202 |
| 58 | `src/modules/clientes/forms/client_subfolders_dialog.py` | 200 |
| 59 | `tests/modules/auditoria/test_auditoria_service_uploads.py` | 198 |
| 60 | `src/core/services/lixeira_service.py` | 197 |
| 61 | `src/core/api/api_clients.py` | 194 |
| 62 | `src/utils/themes.py` | 189 |
| 63 | `src/modules/hub/authors.py` | 187 |
| 64 | `src/modules/uploads/repository.py` | 185 |
| 65 | `src/utils/prefs.py` | 181 |
| 66 | `src/modules/uploads/validation.py` | 181 |
| 67 | `scripts/test_search_normalize.py` | 181 |
| 68 | `scripts/test_deterministic_progress.py` | 177 |
| 69 | `src/modules/clientes/views/pick_mode.py` | 173 |
| 70 | `src/ui/subpastas_dialog.py` | 171 |
| 71 | `src/modules/auditoria/application/controller.py` | 168 |
| 72 | `tests/modules/auditoria/test_auditoria_service_data.py` | 167 |
| 73 | `src/app_status.py` | 165 |
| 74 | `src/modules/auditoria/views/components.py` | 163 |
| 75 | `src/modules/auditoria/views/storage_actions.py` | 157 |
| 76 | `src/utils/file_utils/path_utils.py` | 156 |
| 77 | `src/modules/auditoria/views/layout.py` | 154 |
| 78 | `tests/test_clientes_service.py` | 153 |
| 79 | `src/core/status_monitor.py` | 153 |
| 80 | `tests/test_lixeira_service.py` | 152 |
| 81 | `src/ui/custom_dialogs.py` | 152 |
| 82 | `devtools/qa/analyze_top_errors.py` | 151 |
| 83 | `scripts/dev_smoke.py` | 149 |
| 84 | `src/core/api/api_notes.py` | 147 |
| 85 | `src/ui/login_dialog.py` | 146 |
| 86 | `src/utils/typing_helpers.py` | 141 |
| 87 | `src/core/services/profiles_service.py` | 141 |
| 88 | `src/utils/network.py` | 140 |
| 89 | `src/ui/components/inputs.py` | 135 |
| 90 | `src/core/search/search.py` | 131 |
| 91 | `src/ui/menu_bar.py` | 128 |
| 92 | `src/modules/pdf_preview/controller.py` | 126 |
| 93 | `src/modules/clientes/forms/client_subfolder_prompt.py` | 126 |
| 94 | `devtools/qa/analyze_style_issues.py` | 126 |
| 95 | `src/app_utils.py` | 123 |
| 96 | `src/core/services/path_resolver.py` | 122 |
| 97 | `src/modules/pdf_preview/raster_service.py` | 119 |
| 98 | `devtools/qa/analyze_unknown_errors.py` | 116 |
| 99 | `src/modules/pdf_preview/download_service.py` | 113 |
| 100 | `devtools/qa/analyze_pyright_warnings.py` | 113 |
| 101 | `devtools/qa/analyze_linters.py` | 113 |
| 102 | `src/core/session/session.py` | 112 |
| 103 | `src/shared/storage_ui_bridge.py` | 110 |
| 104 | `src/ui/dialogs/file_select.py` | 109 |
| 105 | `tests/test_env_precedence.py` | 107 |
| 106 | `src/modules/auditoria/storage.py` | 107 |
| 107 | `src/utils/subpastas_config.py` | 105 |
| 108 | `src/modules/clientes/components/helpers.py` | 103 |
| 109 | `src/core/auth_controller.py` | 99 |
| 110 | `adapters/storage/api.py` | 99 |
| 111 | `tests/test_prefs.py` | 98 |
| 112 | `tests/test_paths.py` | 98 |
| 113 | `src/ui/utils.py` | 98 |
| 114 | `scripts/test_upload_thread.py` | 98 |
| 115 | `infra/settings.py` | 98 |
| 116 | `infra/net_status.py` | 98 |
| 117 | `tests/test_network.py` | 97 |
| 118 | `src/features/cashflow/dialogs.py` | 97 |
| 119 | `scripts/demo_duplicates_dialog.py` | 97 |
| 120 | `src/modules/auditoria/__init__.py` | 95 |
| 121 | `src/ui/placeholders.py` | 94 |
| 122 | `src/utils/helpers/hidpi.py` | 93 |
| 123 | `src/modules/passwords/controller.py` | 93 |
| 124 | `devtools/qa/analyze_path_errors.py` | 93 |
| 125 | `src/ui/widgets/busy.py` | 92 |
| 126 | `src/ui/components/lists.py` | 92 |
| 127 | `infra/net_session.py` | 92 |
| 128 | `src/ui/status_footer.py` | 90 |
| 129 | `src/utils/paths.py` | 86 |
| 130 | `src/utils/theme_manager.py` | 85 |
| 131 | `data/domain_types.py` | 85 |
| 132 | `src/ui/window_policy.py` | 84 |
| 133 | `src/helpers/formatters.py` | 84 |
| 134 | `tests/modules/clientes/test_clientes_viewmodel.py` | 83 |
| 135 | `src/ui/pdf_preview_native.py` | 83 |
| 136 | `devtools/qa/analyze_pyright_errors.py` | 83 |
| 137 | `tests/test_errors.py` | 82 |
| 138 | `src/modules/hub/colors.py` | 82 |
| 139 | `src/modules/pdf_preview/views/text_panel.py` | 81 |
| 140 | `src/core/logs/filters.py` | 80 |
| 141 | `scripts/test_file_dialog_manual.py` | 80 |
| 142 | `src/utils/errors.py` | 79 |
| 143 | `scripts/demo_archive_support.py` | 79 |
| 144 | `src/cli.py` | 78 |
| 145 | `src/ui/dialogs/upload_progress.py` | 77 |
| 146 | `src/modules/clientes/views/footer.py` | 75 |
| 147 | `src/utils/phone_utils.py` | 74 |
| 148 | `src/ui/components/buttons.py` | 74 |
| 149 | `src/core/storage_key.py` | 74 |
| 150 | `src/modules/auditoria/repository.py` | 73 |

## 2. Paths contendo cliente/clientes/client

- `infra/supabase/auth_client.py`
- `infra/supabase/db_client.py`
- `infra/supabase/http_client.py`
- `infra/supabase/storage_client.py`
- `infra/supabase_client.py`
- `src/core/api/api_clients.py`
- `src/core/services/clientes_service.py`
- `src/modules/auditoria/views/client_helpers.py`
- `src/modules/clientes/__init__.py`
- `src/modules/clientes/components/helpers.py`
- `src/modules/clientes/controllers/connectivity.py`
- `src/modules/clientes/forms/__init__.py`
- `src/modules/clientes/forms/client_form.py`
- `src/modules/clientes/forms/client_picker.py`
- `src/modules/clientes/forms/client_subfolder_prompt.py`
- `src/modules/clientes/forms/client_subfolders_dialog.py`
- `src/modules/clientes/forms/pipeline.py`
- `src/modules/clientes/service.py`
- `src/modules/clientes/view.py`
- `src/modules/clientes/viewmodel.py`
- `src/modules/clientes/views/__init__.py`
- `src/modules/clientes/views/footer.py`
- `src/modules/clientes/views/main_screen.py`
- `src/modules/clientes/views/pick_mode.py`
- `src/modules/clientes/views/toolbar.py`
- `src/ui/widgets/client_picker.py`
- `tests/modules/clientes/test_clientes_service_status.py`
- `tests/modules/clientes/test_clientes_viewmodel.py`
- `tests/test_clientes_integration.py`
- `tests/test_clientes_service.py`
- `tests/test_clientes_status_helpers.py`

## 3. Grep com snippets (5?10 linhas)

### salvar_cliente

- `src/core/services/clientes_service.py`:188

```text
188:         log.exception("Falha ao migrar pasta (%s -> %s)", old_path, nova_pasta)\n189: \n190: \n191: def salvar_cliente(row, valores: dict) -> tuple[int, str]:\n192:     """\n193:     Cria/atualiza cliente.\n194:     - Permite duplicatas de Nome e WhatsApp.
```

- `src/modules/clientes/__init__.py`:8

```text
8:     excluir_clientes_definitivamente,\n9:     mover_cliente_para_lixeira,\n10:     restaurar_clientes_da_lixeira,\n11:     salvar_cliente_a_partir_do_form,\n12:     listar_clientes_na_lixeira,\n13: )\n14: from .view import ClientesFrame, DEFAULT_ORDER_LABEL, ORDER_CHOICES
```

- `src/modules/clientes/forms/client_form.py`:13

```text
13: from src.modules.clientes.service import (\n14:     ClienteCNPJDuplicadoError,\n15:     checar_duplicatas_para_form,\n16:     salvar_cliente_a_partir_do_form,\n17: )\n18: from src.ui.components import labeled_entry, toolbar_button\n19: from src.ui.forms.actions import preencher_via_pasta, salvar_e_upload_docs
```

- `src/modules/clientes/forms/pipeline.py`:24

```text
24: from src.core.logger import get_logger\n25: from src.core.cnpj_norm import normalize_cnpj as normalize_cnpj_norm\n26: from src.core.db_manager import find_cliente_by_cnpj_norm\n27: from src.core.services.clientes_service import checar_duplicatas_info, salvar_cliente\n28: from src.modules.clientes.service import excluir_cliente_simples\n29: from src.core.storage_key import make_storage_key, storage_slug_part\n30:
```

- `src/modules/clientes/service.py`:40

```text
40:     "get_cliente_by_id",\n41:     "fetch_cliente_by_id",\n42:     "update_cliente_status_and_observacoes",\n43:     "salvar_cliente_a_partir_do_form",\n44: ]\n45: \n46: count_clients = _legacy_clientes_service.count_clients
```

- `src/modules/forms/service.py`:8

```text
8: \n9: from src.core.services import clientes_service\n10: \n11: salvar_cliente = clientes_service.salvar_cliente\n12: checar_duplicatas_info = clientes_service.checar_duplicatas_info\n13: \n14: __all__ = [
```

- `tests/test_clientes_integration.py`:49

```text
49:         callback(*cb_args, **cb_kwargs)\n50: \n51: \n52: def test_fluxo_salvar_cliente_com_upload_integra_pipeline_e_service(monkeypatch: pytest.MonkeyPatch, tmp_path) -> None:\n53:     app = DummyApp()\n54:     arquivo = tmp_path / "doc1.pdf"\n55:     arquivo.write_bytes(b"arquivo-teste")
```

- `tests/test_clientes_service.py`:98

```text
98:     assert result["razao_conflicts"] == []\n99: \n100: \n101: def test_salvar_cliente_cria_novo_quando_row_none(monkeypatch):\n102:     inserted = []\n103: \n104:     def fake_insert(**kw):
```

- `tests/test_modules_aliases.py`:14

```text
14: \n15:     assert mod.count_clients is legacy.count_clients\n16:     assert mod.checar_duplicatas_info is legacy.checar_duplicatas_info\n17:     assert mod.salvar_cliente is legacy.salvar_cliente\n18: \n19: \n20: def test_lixeira_service_aliases() -> None:
```


### checar_duplicatas | checar_duplicatas_info | duplicate

#### Termo `checar_duplicatas`

- `src/core/services/clientes_service.py`:121

```text
121:     return razao, cnpj, cnpj_norm, nome, numero, obs\n122: \n123: \n124: def checar_duplicatas_info(\n125:     numero: str,\n126:     cnpj: str,\n127:     nome: str,
```

- `src/modules/clientes/__init__.py`:4

```text
4: \n5: from .service import (\n6:     ClienteCNPJDuplicadoError,\n7:     checar_duplicatas_para_form,\n8:     excluir_clientes_definitivamente,\n9:     mover_cliente_para_lixeira,\n10:     restaurar_clientes_da_lixeira,
```

- `src/modules/clientes/forms/client_form.py`:12

```text
12: from src.modules.clientes.components.helpers import STATUS_CHOICES, STATUS_PREFIX_RE\n13: from src.modules.clientes.service import (\n14:     ClienteCNPJDuplicadoError,\n15:     checar_duplicatas_para_form,\n16:     salvar_cliente_a_partir_do_form,\n17: )\n18: from src.ui.components import labeled_entry, toolbar_button
```

- `src/modules/clientes/forms/pipeline.py`:24

```text
24: from src.core.logger import get_logger\n25: from src.core.cnpj_norm import normalize_cnpj as normalize_cnpj_norm\n26: from src.core.db_manager import find_cliente_by_cnpj_norm\n27: from src.core.services.clientes_service import checar_duplicatas_info, salvar_cliente\n28: from src.modules.clientes.service import excluir_cliente_simples\n29: from src.core.storage_key import make_storage_key, storage_slug_part\n30:
```

- `src/modules/clientes/service.py`:31

```text
31: \n32: __all__ = [\n33:     "ClienteCNPJDuplicadoError",\n34:     "checar_duplicatas_para_form",\n35:     "mover_cliente_para_lixeira",\n36:     "restaurar_clientes_da_lixeira",\n37:     "excluir_clientes_definitivamente",
```

- `src/modules/forms/service.py`:9

```text
9: from src.core.services import clientes_service\n10: \n11: salvar_cliente = clientes_service.salvar_cliente\n12: checar_duplicatas_info = clientes_service.checar_duplicatas_info\n13: \n14: __all__ = [\n15:     "salvar_cliente",
```

- `tests/test_clientes_integration.py`:64

```text
64: \n65:     monkeypatch.setattr(clientes_pipeline, "get_supabase_state", lambda: ("online", "ok"))\n66:     monkeypatch.setattr(clientes_pipeline, "find_cliente_by_cnpj_norm", lambda *a, **k: None)\n67:     monkeypatch.setattr(clientes_pipeline, "checar_duplicatas_info", lambda **k: {})\n68:     monkeypatch.setattr(clientes_pipeline, "salvar_cliente", lambda row, valores: (123, str(tmp_path / "cliente123")))\n69:     monkeypatch.setattr(clientes_pipeline, "_current_user_id", lambda: "user-1")\n70:     monkeypatch.setattr(clientes_pipeline, "_resolve_org_id", lambda: "org-1")
```

- `tests/test_clientes_service.py`:51

```text
51:     assert clientes_service.count_clients(max_retries=0) == 7\n52: \n53: \n54: def test_checar_duplicatas_info_sem_conflitos(monkeypatch):\n55:     monkeypatch.setattr(clientes_service, "find_cliente_by_cnpj_norm", lambda *a, **k: None)\n56:     monkeypatch.setattr(clientes_service, "list_clientes", lambda: [])\n57:
```

- `tests/test_modules_aliases.py`:13

```text
13:     from src.core.services import clientes_service as legacy\n14: \n15:     assert mod.count_clients is legacy.count_clients\n16:     assert mod.checar_duplicatas_info is legacy.checar_duplicatas_info\n17:     assert mod.salvar_cliente is legacy.salvar_cliente\n18: \n19:
```

#### Termo `checar_duplicatas_info`

- `src/core/services/clientes_service.py`:121

```text
121:     return razao, cnpj, cnpj_norm, nome, numero, obs\n122: \n123: \n124: def checar_duplicatas_info(\n125:     numero: str,\n126:     cnpj: str,\n127:     nome: str,
```

- `src/modules/clientes/forms/pipeline.py`:24

```text
24: from src.core.logger import get_logger\n25: from src.core.cnpj_norm import normalize_cnpj as normalize_cnpj_norm\n26: from src.core.db_manager import find_cliente_by_cnpj_norm\n27: from src.core.services.clientes_service import checar_duplicatas_info, salvar_cliente\n28: from src.modules.clientes.service import excluir_cliente_simples\n29: from src.core.storage_key import make_storage_key, storage_slug_part\n30:
```

- `src/modules/clientes/service.py`:44

```text
44: ]\n45: \n46: count_clients = _legacy_clientes_service.count_clients\n47: checar_duplicatas_info = _legacy_clientes_service.checar_duplicatas_info\n48: salvar_cliente = _legacy_clientes_service.salvar_cliente\n49: \n50: log = logging.getLogger(__name__)
```

- `src/modules/forms/service.py`:9

```text
9: from src.core.services import clientes_service\n10: \n11: salvar_cliente = clientes_service.salvar_cliente\n12: checar_duplicatas_info = clientes_service.checar_duplicatas_info\n13: \n14: __all__ = [\n15:     "salvar_cliente",
```

- `tests/test_clientes_integration.py`:64

```text
64: \n65:     monkeypatch.setattr(clientes_pipeline, "get_supabase_state", lambda: ("online", "ok"))\n66:     monkeypatch.setattr(clientes_pipeline, "find_cliente_by_cnpj_norm", lambda *a, **k: None)\n67:     monkeypatch.setattr(clientes_pipeline, "checar_duplicatas_info", lambda **k: {})\n68:     monkeypatch.setattr(clientes_pipeline, "salvar_cliente", lambda row, valores: (123, str(tmp_path / "cliente123")))\n69:     monkeypatch.setattr(clientes_pipeline, "_current_user_id", lambda: "user-1")\n70:     monkeypatch.setattr(clientes_pipeline, "_resolve_org_id", lambda: "org-1")
```

- `tests/test_clientes_service.py`:51

```text
51:     assert clientes_service.count_clients(max_retries=0) == 7\n52: \n53: \n54: def test_checar_duplicatas_info_sem_conflitos(monkeypatch):\n55:     monkeypatch.setattr(clientes_service, "find_cliente_by_cnpj_norm", lambda *a, **k: None)\n56:     monkeypatch.setattr(clientes_service, "list_clientes", lambda: [])\n57:
```

- `tests/test_modules_aliases.py`:13

```text
13:     from src.core.services import clientes_service as legacy\n14: \n15:     assert mod.count_clients is legacy.count_clients\n16:     assert mod.checar_duplicatas_info is legacy.checar_duplicatas_info\n17:     assert mod.salvar_cliente is legacy.salvar_cliente\n18: \n19:
```


### deleted_at

- `data/supabase_repo.py`:358

```text
358:             supabase.table("clients")\n359:             .select("id, org_id, razao_social, cnpj, nome, numero, obs, cnpj_norm")\n360:             .eq("org_id", org_id)\n361:             .is_("deleted_at", None)\n362:         )\n363: \n364:         if len(q) >= 2:
```

- `src/core/db_manager/db_manager.py`:29

```text
29:     "ultima_alteracao": ("ultima_alteracao", True),  # mais recente primeiro por padrão\n30: }\n31: \n32: CLIENT_COLUMNS = "id,numero,nome,razao_social,cnpj,cnpj_norm,ultima_alteracao,ultima_por,obs,org_id,deleted_at"\n33: \n34: \n35: # -----------------------------------------------------------------------------
```

- `src/core/search/search.py`:100

```text
100:                 raise ValueError("org_id obrigatorio")\n101: \n102:             def _fetch_rows(search_term: str | None) -> List[dict]:\n103:                 qb = supabase.table("clients").select(CLIENT_COLUMNS).is_("deleted_at", "null").eq("org_id", org_id)\n104:                 if search_term:\n105:                     pat = f"%{search_term}%"\n106:                     qb = qb.or_("nome.ilike.{pat},razao_social.ilike.{pat},cnpj.ilike.{pat},numero.ilike.{pat}".format(pat=pat))
```

- `src/core/services/clientes_service.py`:36

```text
36:     Executa a contagem real de clientes no Supabase.\n37:     C�digo original extra�do para isolamento de retry.\n38:     """\n39:     resp = exec_postgrest(supabase.table("clients").select("id", count="exact").is_("deleted_at", "null"))\n40:     return resp.count or 0\n41: \n42:
```

- `src/core/services/lixeira_service.py`:130

```text
130: \n131: # ----------------- Ações públicas -----------------\n132: def restore_clients(client_ids: Iterable[int], parent=None) -> Tuple[int, List[Tuple[int, str]]]:\n133:     """Restaura clientes (deleted_at = null). Retorna (qtd_ok, [(client_id, err), ...])."""\n134:     ok = 0\n135:     errs: List[Tuple[int, str]] = []\n136:     parent_widget: tk.Misc | None = parent if isinstance(parent, tk.Misc) else None
```

- `src/modules/clientes/service.py`:122

```text
122: \n123: def mover_cliente_para_lixeira(cliente_id: int) -> None:\n124:     """\n125:     Marca o cliente como deletado (soft delete) atualizando os campos deleted_at/ultima_alteracao.\n126:     """\n127: \n128:     deleted_at = _current_utc_iso()
```

- `src/utils/validators.py`:135

```text
135:             union_sql = []\n136: \n137:             if cnpj_d:\n138:                 union_sql.append("SELECT 'CNPJ' AS K, ID FROM clientes WHERE DELETED_AT IS NULL AND CNPJ = ?")\n139:                 params.append(cnpj_d)\n140: \n141:             # (removido) bloqueio por número/WhatsApp
```

- `tests/test_clientes_integration.py`:210

```text
210:     clientes_service.mover_cliente_para_lixeira(77)\n211:     query = recorded["query"]\n212:     assert query.table_name == "clients"\n213:     assert query.payload["deleted_at"].startswith("2025-01-01")\n214:     assert query.eq_value == ("id", 77)\n215: \n216:     monkeypatch.setattr(
```


### supabase

- `adapters/storage/__init__.py`:1

```text
1: from . import api, port, supabase_storage\n2: \n3: __all__ = ["port", "supabase_storage", "api"]
```

- `adapters/storage/api.py`:5

```text
5: from typing import Any, Iterable, Optional, Union\n6: \n7: from .port import StoragePort\n8: from . import supabase_storage\n9: from .supabase_storage import DownloadCancelledError\n10: \n11: # Backend pode ser um módulo com funções (supabase_storage) ou uma instância StoragePort.
```

- `adapters/storage/supabase_storage.py`:1

```text
1: # adapters/storage/supabase_storage.py\n2: from __future__ import annotations\n3: \n4: import mimetypes
```

- `data/auth_bootstrap.py`:26

```text
26: \n27: def ensure_signed_in(client) -> None:\n28:     """\n29:     Garante que exista sessão válida no Supabase.\n30:     Fluxo:\n31:       1) Se já há sessão -> apenas injeta no PostgREST e retorna.\n32:       2) Se não há sessão -> tenta login headless com SUPABASE_EMAIL/SUPABASE_PASSWORD (.env) para DEV.
```

- `data/domain_types.py`:1

```text
1: # -*- coding: utf-8 -*-\n2: # data/domain_types.py\n3: """Domain TypedDicts for Supabase table rows.\n4: \n5: This module defines typed dictionaries representing the structure of database rows\n6: for the main tables in the application. These types improve type safety and IDE
```

- `data/supabase_repo.py`:1

```text
1: # -*- coding: utf-8 -*-\n2: # data/supabase_repo.py\n3: """Repositório Supabase para operações CRUD na tabela client_passwords."""\n4: \n5: from __future__ import annotations
```

- `devtools/arch/analyze_modules.py`:75

```text
75: \n76:     # Infrastructure indicators\n77:     infra_indicators = [\n78:         "supabase", "httpx", "requests", "psycopg", "sqlalchemy",\n79:         "redis", "cache", "from infra", "import infra"\n80:     ]\n81:     if any(indicator in content_lower for indicator in infra_indicators):
```

- `devtools/qa/analyze_supabase_errors.py`:1

```text
1: #!/usr/bin/env python3\n2: """Analyze Pyright errors specific to Supabase repository and client modules.\n3: \n4: Filters diagnostics for supabase_repo.py and supabase_client.py to identify\n5: type annotation opportunities for CompatPack-08.
```

- `infra/__init__.py`:1

```text
1: # -*- coding: utf-8 -*-\n2: """Infrastructure layer: external systems integration (Supabase, network, etc)."""
```

- `infra/healthcheck.py`:4

```text
4: import uuid\n5: import logging\n6: \n7: from infra.supabase_client import get_supabase\n8: from src.core.session.session_guard import SessionGuard\n9: \n10: log = logging.getLogger(__name__)
```

- `infra/net_status.py`:27

```text
27:             u = "https://" + u\n28:         return u.rstrip("/")\n29: \n30:     env_url = (os.getenv("SUPABASE_URL") or "").strip()\n31:     if env_url:\n32:         if not env_url.startswith("http"):\n33:             env_url = "https://" + env_url
```

- `infra/repositories/passwords_repository.py`:10

```text
10: \n11: def get_passwords(org_id: str, search_text: Optional[str] = None, client_filter: Optional[str] = None) -> list[PasswordRow]:\n12:     """Lista senhas com filtros opcionais."""\n13:     from data.supabase_repo import list_passwords\n14:     passwords = list_passwords(org_id)\n15: \n16:     if search_text:
```

- `infra/supabase/auth_client.py`:2

```text
2: \n3: import logging\n4: \n5: from supabase import Client\n6: \n7: log = logging.getLogger(__name__)\n8:
```

- `infra/supabase/db_client.py`:6

```text
6: import time\n7: from typing import Any, TypeVar\n8: \n9: from supabase import Client, ClientOptions, create_client  # type: ignore[import-untyped]\n10: \n11: from infra.http.retry import retry_call\n12: from infra.supabase import types as supa_types
```

- `infra/supabase/storage_client.py`:15

```text
15: from requests import exceptions as req_exc\n16: \n17: from infra.net_session import make_session\n18: from infra.supabase.types import SUPABASE_ANON_KEY, SUPABASE_URL\n19: \n20: logger = logging.getLogger("infra.supabase.storage_client")\n21:
```

- `infra/supabase/storage_helpers.py`:1

```text
1: """Utility helpers for working with Supabase Storage objects."""\n2: \n3: from __future__ import annotations\n4:
```

- `infra/supabase/types.py`:7

```text
7: \n8: load_env()\n9: \n10: SUPABASE_URL: Optional[str] = env_str("SUPABASE_URL")\n11: SUPABASE_ANON_KEY: Optional[str] = env_str("SUPABASE_ANON_KEY")\n12: SUPABASE_BUCKET: str = env_str("SUPABASE_BUCKET") or "rc-docs"\n13:
```

- `infra/supabase_auth.py`:1

```text
1: # infra/supabase_auth.py\n2: from __future__ import annotations\n3: import logging\n4: from typing import Tuple
```

- `infra/supabase_client.py`:1

```text
1: from __future__ import annotations\n2: \n3: from infra.supabase.auth_client import bind_postgrest_auth_if_any\n4: from infra.supabase.db_client import (\n5:     exec_postgrest,\n6:     get_cloud_status_for_ui,
```

- `scripts/dev_smoke.py`:78

```text
78:     print("=" * 60)\n79: \n80:     imports_to_test = [\n81:         ("infra.supabase_client", "exec_postgrest"),\n82:         ("ui.components", "toolbar_button"),\n83:         ("utils.file_utils.file_utils", "ensure_dir"),\n84:         ("application.api", "register_endpoints"),
```

- `scripts/test_upload_advanced.py`:125

```text
125:     root = tk.Tk()\n126:     root.withdraw()\n127: \n128:     # Criar frame (sem supabase - só para testar helper)\n129:     frame = AuditoriaFrame(root, None)\n130: \n131:     # Testes
```

- `scripts/validate_7z_support.py`:35

```text
35:     """Verifica dependências essenciais."""\n36:     deps = {\n37:         "ttkbootstrap": ("Interface gráfica", True),\n38:         "supabase": ("Cliente Supabase", True),\n39:         "PyMuPDF": ("Visualização de PDFs", False),  # Opcional\n40:         "pathlib": ("Manipulação de paths (built-in)", True),\n41:         "tempfile": ("Arquivos temporários (built-in)", True),
```

- `src/app_core.py`:57

```text
57:     try:\n58:         cliente = get_cliente_by_id(pk)\n59:     except Exception:\n60:         log.exception("Failed to resolve client %s from Supabase", pk)\n61:         return None\n62: \n63:     if cliente is None:
```

- `src/app_gui.py`:65

```text
65: \n66:     from src.modules.login.view import LoginDialog, show_splash  # Novo diálogo simplificado\n67: \n68:     # [startup-fix] import seguro do supabase\n69:     try:\n70:         from infra.supabase_client import bind_postgrest_auth_if_any\n71:         from infra.supabase_client import get_supabase as _get_supabase
```

- `src/core/api/api_files.py`:25

```text
25: \n26:     Where to edit:\n27:         - Upload logic: adapters/storage/api.py\n28:         - Backend implementation: adapters/storage/supabase_storage.py\n29:     """\n30:     try:\n31:         from adapters.storage import api as storage_api
```

- `src/core/auth/auth.py`:18

```text
18: import logging\n19: from threading import Lock\n20: \n21: from infra.supabase_client import get_supabase  # cliente lazy singleton\n22: from src.config.paths import USERS_DB_PATH\n23: \n24: log = logging.getLogger(__name__)
```

- `src/core/db_manager/db_manager.py`:1

```text
1: # core/db_manager/db_manager.py  (versão Supabase)\n2: from __future__ import annotations\n3: \n4: import logging
```

- `src/core/search/search.py`:1

```text
1: """Client search helpers using Supabase with local fallback."""\n2: \n3: from __future__ import annotations\n4:
```

- `src/core/services/clientes_service.py`:1

```text
1: # core/services/clientes_service.py � vers�o Supabase (libera Nome/Whats; mant�m CNPJ/Raz�o)\n2: from __future__ import annotations\n3: \n4: import logging
```

- `src/core/services/lixeira_service.py`:12

```text
12: from adapters.storage.api import list_files as storage_list_files\n13: from adapters.storage.api import upload_file as storage_upload_file\n14: from adapters.storage.api import using_storage_backend\n15: from adapters.storage.supabase_storage import SupabaseStorageAdapter\n16: from infra.supabase_client import exec_postgrest\n17: from src.utils.subpastas_config import get_mandatory_subpastas, join_prefix\n18:
```

- `src/core/services/notes_service.py`:9

```text
9: import time\n10: from typing import Any, Callable, Dict, List\n11: \n12: from infra.supabase_client import exec_postgrest, get_supabase\n13: \n14: log = logging.getLogger(__name__)\n15:
```

- `src/core/services/profiles_service.py`:6

```text
6: import logging\n7: from typing import Any, Dict, List, Optional\n8: \n9: from infra.supabase_client import exec_postgrest, get_supabase\n10: \n11: log = logging.getLogger(__name__)\n12:
```

- `src/core/services/upload_service.py`:2

```text
2: \n3: from __future__ import annotations\n4: \n5: from src.modules.uploads.service import upload_folder_to_supabase\n6: \n7: __all__ = ["upload_folder_to_supabase"]
```

- `src/core/session/session.py`:1

```text
1: # -*- coding: utf-8 -*-\n2: """Sessão do usuário logado + tokens do Supabase, com org_id carregado da tabela memberships."""\n3: \n4: from __future__ import annotations\n5:
```

- `src/core/session/session_guard.py`:1

```text
1: # core/session/session_guard.py\n2: from __future__ import annotations\n3: \n4: from infra.supabase_client import get_supabase\n5: from src.core import session\n6: \n7:
```

- `src/core/settings.py`:9

```text
9: \n10: # Chaves centrais (pode expandir conforme o projeto)\n11: DEFAULT_PASSWORD: Final[str] = env("APP_DEFAULT_PASSWORD", "")\n12: SUPABASE_URL: Final[str] = env("SUPABASE_URL", "")\n13: SUPABASE_KEY: Final[str] = env("SUPABASE_KEY", "")
```

- `src/core/storage_key.py`:1

```text
1: # -*- coding: utf-8 -*-\n2: """\n3: Utilities to build Supabase Storage object keys using a safe ASCII subset.\n4: """\n5: \n6: from __future__ import annotations
```

- `src/features/cashflow/repository.py`:15

```text
15: \n16: \n17: # ---------------------------------------------------------------------------\n18: # Cliente Supabase do projeto — compatível com vários layouts\n19: # Tenta nesta ordem:\n20: # 1) relativo (projetos com pacote "src"): ...infra.supabase.db_client.get_client\n21: # 2) relativo fallback: ...infra.supabase_client.get_supabase
```

- `src/modules/auditoria/__init__.py`:29

```text
29:     get_clients_bucket,\n30:     get_current_org_id,\n31:     get_storage_context,\n32:     get_supabase_client,\n33:     is_online,\n34:     is_supported_archive,\n35:     list_auditorias,
```

- `src/modules/auditoria/application/controller.py`:52

```text
52:     def ensure_storage_ready(self) -> None:\n53:         self._service.ensure_storage_ready()\n54: \n55:     def get_supabase_client(self) -> Any | None:\n56:         return self._service.get_supabase_client()\n57: \n58:     # --- Data operations ---------------------------------------------------
```

- `src/modules/auditoria/repository.py`:1

```text
1: """Supabase data-access helpers for the Auditoria module."""\n2: \n3: from __future__ import annotations\n4:
```

- `src/modules/auditoria/service.py`:2

```text
2: Servicos de dominio do modulo Auditoria.\n3: \n4: Este modulo concentra:\n5: - operacoes de dados (listar/iniciar/atualizar/excluir auditorias e clientes) via Supabase;\n6: - operacoes de storage (resolver bucket/prefixo, garantir pastas e enviar/remover arquivos);\n7: - wrappers para utilitarios de arquivos definidos em infra.archive_utils (ZIP/RAR/7z).\n8: """
```

- `src/modules/auditoria/views/main_frame.py`:36

```text
36:         return f"{c[:2]}.{c[2:5]}.{c[5:8]}/{c[8:12]}-{c[12:14]}" if len(c) == 14 else (cnpj or "")\n37: \n38: \n39: OFFLINE_MSG = "Recurso on-line. Verifique internet e credenciais do Supabase."\n40: \n41: \n42: class AuditoriaFrame(ttk.Frame):
```

- `src/modules/auditoria/views/storage_actions.py`:28

```text
28:         Abre janela de arquivos da auditoria selecionada.\n29:         Garante apenas 1 janela por auditoria (foca se já existe).\n30:         """\n31:         supabase_client = self.controller.get_supabase_client()\n32:         if not supabase_client:\n33:             messagebox.showwarning("Storage", "Sem conexão com a nuvem.")\n34:             return
```

- `src/modules/auditoria/views/upload_flow.py`:161

```text
161:                     delete_handler = self.controller.make_delete_folder_handler(base_prefix)\n162:                     open_files_browser(\n163:                         self.frame,\n164:                         supabase=self.controller.get_supabase_client(),\n165:                         client_id=client_id,\n166:                         org_id=org_id,\n167:                         razao=cliente_nome,
```

- `src/modules/clientes/controllers/connectivity.py`:3

```text
3: from dataclasses import dataclass\n4: from typing import Optional, TYPE_CHECKING\n5: \n6: from infra.supabase_client import get_cloud_status_for_ui, get_supabase_state\n7: \n8: if TYPE_CHECKING:\n9:     from ..views.main_screen import MainScreenFrame
```

- `src/modules/clientes/forms/client_picker.py`:174

```text
174:     def _load_initial(self) -> None:\n175:         """Carrega lista inicial de clientes ao abrir modal."""\n176:         try:\n177:             from data.supabase_repo import list_clients_for_picker\n178: \n179:             results: list[ClientRow] = list_clients_for_picker(self.org_id, limit=500)\n180:             self._fill_table(results)
```

- `src/modules/clientes/forms/pipeline.py`:18

```text
18: from adapters.storage.api import delete_file as storage_delete_file\n19: from adapters.storage.api import upload_file as storage_upload_file\n20: from adapters.storage.api import using_storage_backend\n21: from adapters.storage.supabase_storage import SupabaseStorageAdapter\n22: from infra.supabase_client import exec_postgrest, get_supabase_state, supabase\n23: from src.config.paths import CLOUD_ONLY\n24: from src.core.logger import get_logger
```

- `src/modules/clientes/service.py`:15

```text
15:     list_files as storage_list_files,\n16:     using_storage_backend,\n17: )\n18: from adapters.storage.supabase_storage import SupabaseStorageAdapter\n19: from infra.supabase_client import exec_postgrest, supabase\n20: from src.core.cnpj_norm import normalize_cnpj as normalize_cnpj_norm\n21: from src.core.db_manager import (
```

- `src/modules/clientes/views/footer.py`:21

```text
21:         on_novo: Callable[[], None],\n22:         on_editar: Callable[[], None],\n23:         on_subpastas: Callable[[], None],\n24:         on_enviar_supabase: Callable[[], None],\n25:         on_enviar_pasta: Callable[[], None],\n26:     ) -> None:\n27:         super().__init__(master)
```

- `src/modules/clientes/views/main_screen.py`:22

```text
22: except Exception:\n23:     tb = ttk  # fallback\n24: \n25: from infra.supabase_client import get_supabase_state\n26: \n27: from src.ui.components import create_clients_treeview\n28:
```

- `src/modules/hub/actions.py`:228

```text
228: \n229: \n230:             table_missing = True\n231:             error_msg = "Tabela de anotações não encontrada no Supabase."\n232:             log.warning("HubScreen: %s", exc)\n233: \n234:
```

- `src/modules/hub/authors.py`:46

```text
46:         author_cache = {}\n47:         setattr(screen, "_author_names_cache", author_cache)\n48: \n49:     # 1) cache Supabase com TTL (+ compat str)\n50:     cached = author_cache.get(key)\n51:     now = time.time()\n52:     if isinstance(cached, tuple):
```

- `src/modules/hub/controller.py`:404

```text
404: \n405:                             "Bloco de anota├º├Áes indispon├¡vel:\n\n"\n406: \n407:                             "A tabela 'rc_notes' n├úo existe no Supabase.\n"\n408: \n409:                             "Execute a migra├º├úo em: migrations/rc_notes_migration.sql\n\n"\n410:
```

- `src/modules/hub/format.py`:12

```text
12: \n13: \n14: def _format_timestamp(ts_iso: str) -> str:\n15:     """Convert Supabase ISO timestamp to local time string dd/mm/YYYY - HH:MM."""\n16:     try:\n17:         if not ts_iso:\n18:             return "?"
```

- `src/modules/hub/views/hub_screen.py`:1

```text
1: # -*- coding: utf-8 -*-\n2: """Tela Hub: menu vertical + bloco de notas compartilhado (append-only via Supabase)."""\n3: \n4: from __future__ import annotations\n5:
```

- `src/modules/lixeira/views/lixeira.py`:1

```text
1: # -*- coding: utf-8 -*-\n2: """Tela da Lixeira (clientes deletados via Supabase - soft delete)."""\n3: \n4: from __future__ import annotations\n5:
```

- `src/modules/login/view.py`:11

```text
11: from __future__ import annotations\n12: \n13: from src.ui.login import LoginDialog as LegacyLoginDialog\n14: from src.ui.login_dialog import LoginDialog as SupabaseLoginDialog\n15: from src.ui.splash import show_splash\n16: \n17: # Alias principal compatível com o diálogo usado atualmente
```

- `src/modules/main_window/controller.py`:119

```text
119:         on_new=app.novo_cliente,\n120:         on_edit=app.editar_cliente,\n121:         on_delete=app._excluir_cliente,\n122:         on_upload=app.enviar_para_supabase,\n123:         on_open_subpastas=app.ver_subpastas,\n124:         on_open_lixeira=app.abrir_lixeira,\n125:         order_choices=ORDER_CHOICES,
```

- `src/modules/main_window/views/main_window.py`:33

```text
33: from src.ui import custom_dialogs\n34: from src.utils import themes\n35: from src.utils.theme_manager import theme_manager\n36: from uploader_supabase import send_folder_to_supabase, send_to_supabase_interactive\n37: \n38: # -------- Phase 1 + 4: shared helpers with safe fallbacks --------\n39: try:
```

- `src/modules/passwords/controller.py`:4

```text
4: from typing import Optional\n5: \n6: from data.domain_types import ClientRow, PasswordRow\n7: from data.supabase_repo import list_clients_for_picker\n8: from security.crypto import decrypt_text\n9: \n10: from src.modules.passwords import service as passwords_service
```

- `src/modules/passwords/views/passwords_screen.py`:490

```text
490:         """Callback chamado ao exibir a tela."""\n491:         try:\n492:             # Obter org_id e user_id\n493:             from infra.supabase_client import supabase\n494: \n495:             user = supabase.auth.get_user()\n496:             if user and hasattr(user, "user") and user.user:
```

- `src/modules/uploads/__init__.py`:18

```text
18:     get_current_org_id,\n19:     list_storage_objects,\n20:     strip_cnpj_from_razao,\n21:     upload_folder_to_supabase,\n22:     upload_items_for_client,\n23: )\n24: from . import service
```

- `src/modules/uploads/components/helpers.py`:1

```text
1: ﻿"""Helpers de prefixo/CNPJ e Supabase para o modulo Uploads.\n2: \n3: Extraidos de src.ui.files_browser para permitir reutilizacao e testes.\n4: """
```

- `src/modules/uploads/repository.py`:7

```text
7: from typing import Any, Callable, Optional, Sequence, Tuple, TypeVar\n8: \n9: from adapters.storage.api import list_files as _storage_list_files, upload_file as _storage_upload_file\n10: from adapters.storage.supabase_storage import SupabaseStorageAdapter\n11: from infra.supabase_client import exec_postgrest, supabase\n12: \n13: if False:  # pragma: no cover
```

- `src/modules/uploads/service.py`:1

```text
1: """Servicos de dominio do modulo Uploads / Arquivos.\n2: \n3: Concentra helpers de upload/listagem e a logica de integracao com\n4: Supabase/Storage. Arquivos legados (uploader_supabase.py e\n5: src/core/services/upload_service.py) passam a delegar para este modulo.\n6: """\n7:
```

- `src/modules/uploads/validation.py`:15

```text
15: \n16: @dataclass(slots=True)\n17: class PreparedUploadEntry:\n18:     """Metadata necessary to persist a local file into Supabase."""\n19: \n20:     path: Path\n21:     relative_path: str
```

- `src/modules/uploads/view.py`:24

```text
24:     src.ui.files_browser.open_files_browser.\n25: \n26:     Ignora parâmetros extras como `bucket`, `base_prefix` e `modal`,\n27:     preservando `start_prefix`, `module`, `supabase` etc.\n28:     """\n29:     cleaned: Dict[str, Any] = dict(kwargs)\n30:
```

- `src/modules/uploads/views/browser.py`:59

```text
59:         cnpj: str = "",\n60:         bucket: str | None = None,\n61:         base_prefix: str | None = None,\n62:         supabase=None,  # type: ignore[no-untyped-def]\n63:         start_prefix: str = "",\n64:         module: str = "",\n65:         modal: bool = False,
```

- `src/shared/storage_ui_bridge.py`:38

```text
38:             return str(client_id)\n39: \n40: \n41: def _get_org_id_from_supabase(sb) -> Optional[str]:  # type: ignore[no-untyped-def]\n42:     """Obtém org_id do usuário logado via Supabase."""\n43:     try:\n44:         user = sb.auth.get_user()
```

- `src/ui/components/buttons.py`:47

```text
47:     btn_novo = tb.Button(frame, text="Novo Cliente", command=on_novo, bootstyle="success")\n48:     btn_editar = tb.Button(frame, text="Editar", command=on_editar, bootstyle="primary")\n49:     btn_subpastas = tb.Button(frame, text="Ver Subpastas", command=on_subpastas, bootstyle="secondary")\n50:     btn_enviar = ttk.Menubutton(frame, text="Enviar Para SupaBase")\n51:     menu_enviar = tk.Menu(btn_enviar, tearoff=0)\n52:     menu_enviar.add_command(label="Selecionar PDFs...", command=on_enviar)\n53:     menu_enviar.add_command(label="Selecionar Pasta...", command=on_enviar_pasta)
```

- `src/ui/dialogs/__init__.py`:3

```text
3: \n4: from src.ui.dialogs.storage_uploader import (\n5:     StorageDestinationDialog,\n6:     enviar_para_supabase_avancado,\n7: )\n8: from src.ui.dialogs.file_select import (\n9:     select_archive_file,
```

- `src/ui/dialogs/storage_uploader.py`:1

```text
1: # -*- coding: utf-8 -*-\n2: """\n3: Módulo para upload avançado de arquivos/pastas para Supabase Storage.\n4: Permite escolher destino (bucket/pasta), upload múltiplo e progresso visual.\n5: """\n6:
```

- `src/ui/dialogs/upload_progress.py`:6

```text
6: from tkinter import messagebox, ttk\n7: from typing import Any\n8: \n9: from src.modules.uploads.service import upload_folder_to_supabase\n10: from src.utils.resource_path import resource_path\n11: from ui import center_on_parent\n12:
```

- `src/ui/files_browser.py`:53

```text
53:     client_id: int,\n54:     razao: str = "",\n55:     cnpj: str = "",\n56:     supabase=None,  # type: ignore[no-untyped-def]\n57:     start_prefix: str = "",\n58:     module: str = "",\n59:     delete_folder_handler: Callable[[str, str], None] | None = None,
```

- `src/ui/forms/actions.py`:16

```text
16: from adapters.storage.api import (\n17:     using_storage_backend,\n18: )\n19: from adapters.storage.supabase_storage import SupabaseStorageAdapter\n20: from infra.supabase_client import (\n21:     exec_postgrest,\n22:     get_supabase_state,
```

- `src/ui/login/login.py`:154

```text
154:         self.btn_login.configure(state="disabled")\n155:         self.update_idletasks()\n156: \n157:         # Autenticar no Supabase\n158:         ok, msg = authenticate_user(email, password)\n159: \n160:         if ok:
```

- `src/ui/login_dialog.py`:7

```text
7: \n8: from data.auth_bootstrap import _get_access_token\n9: from infra.healthcheck import healthcheck  # <-- ADICIONADO: health check pós-login\n10: from infra.supabase_client import bind_postgrest_auth_if_any, get_supabase\n11: from src.core.auth.auth import authenticate_user  # Import for authenticate_user\n12: from src.core.session.session import (  # <-- importa sessão\n13:     refresh_current_user_from_supabase,
```

- `src/ui/subpastas_dialog.py`:112

```text
112: \n113:         try:\n114:             from adapters.storage.api import list_files, using_storage_backend\n115:             from adapters.storage.supabase_storage import SupabaseStorageAdapter\n116: \n117:             # Limpa tree\n118:             for item in self.tree.get_children():
```

- `src/utils/helpers/cloud_guardrails.py`:24

```text
24:     if CLOUD_ONLY:\n25:         messagebox.showinfo(\n26:             "Atenção",\n27:             f"{operation_name} indisponível no modo Cloud-Only.\n\nUse as funcionalidades baseadas em nuvem (Supabase) disponíveis na interface.",\n28:         )\n29:         return True\n30:     return False
```

- `src/utils/net_retry.py`:11

```text
11: \n12: def run_cloud_op(op: Callable[[], T], retries: int = 2, base_delay: float = 0.5) -> T:\n13:     """\n14:     Executa operação que chama Supabase com retries + refresh de sessão.\n15:     - Se 401/expiração: tenta SessionGuard.ensure_alive() e repete.\n16:     - Backoff simples: base_delay * (2**tentativa)\n17:     Levanta última exceção se falhar.
```

- `tests/modules/auditoria/test_auditoria_service_data.py`:20

```text
20: \n21: \n22: def test_fetch_clients_filters_non_dict_rows(monkeypatch):\n23:     supabase = SimpleNamespace(table=lambda name: _ClientsQueryStub([{"id": 1}, "bad", {"id": 2}]))\n24:     monkeypatch.setattr(auditoria_service, "_require_supabase", lambda: supabase)\n25: \n26:     result = auditoria_service.fetch_clients()
```

- `tests/test_clientes_integration.py`:62

```text
62:     }\n63:     arquivos = [str(arquivo)]\n64: \n65:     monkeypatch.setattr(clientes_pipeline, "get_supabase_state", lambda: ("online", "ok"))\n66:     monkeypatch.setattr(clientes_pipeline, "find_cliente_by_cnpj_norm", lambda *a, **k: None)\n67:     monkeypatch.setattr(clientes_pipeline, "checar_duplicatas_info", lambda **k: {})\n68:     monkeypatch.setattr(clientes_pipeline, "salvar_cliente", lambda row, valores: (123, str(tmp_path / "cliente123")))
```

- `tests/test_env_precedence.py`:86

```text
86:     """Test that the loading order matches what's documented in app_gui.py."""\n87:     # Simulate the exact loading pattern from src/app_gui.py\n88:     bundled = tmp_path / "bundled.env"\n89:     bundled.write_text("RC_LOG_LEVEL=INFO\nSUPABASE_URL=bundled_url\n")\n90: \n91:     local = tmp_path / "local.env"\n92:     local.write_text("SUPABASE_URL=local_url\n")
```

- `tests/test_health_fallback.py`:20

```text
20:     """\n21:     Testa que quando RPC ping retorna 404, o sistema faz fallback para /auth/v1/health.\n22:     """\n23:     from infra.supabase.db_client import _health_check_once\n24: \n25:     # Mock do cliente Supabase\n26:     mock_client = MagicMock()
```

- `tests/test_httpx_timeout_alias.py`:9

```text
9:     Verifica que HTTPX_TIMEOUT existe e aponta para HTTPX_TIMEOUT_LIGHT.\n10:     Compatibilidade retroativa após introdução de LIGHT/HEAVY variants.\n11:     """\n12:     from infra.supabase.http_client import HTTPX_TIMEOUT, HTTPX_TIMEOUT_LIGHT\n13: \n14:     # Deve existir e ser o mesmo objeto (alias, não cópia)\n15:     assert HTTPX_TIMEOUT is HTTPX_TIMEOUT_LIGHT, "HTTPX_TIMEOUT deve ser alias de HTTPX_TIMEOUT_LIGHT"
```

- `tests/test_lixeira_service.py`:25

```text
25: \n26:     monkeypatch.setattr(lixeira_service, "get_mandatory_subpastas", lambda: mandatory)\n27:     monkeypatch.setattr(lixeira_service, "using_storage_backend", lambda adapter: nullcontext())\n28:     monkeypatch.setattr(lixeira_service, "SupabaseStorageAdapter", lambda bucket: object())\n29:     monkeypatch.setattr(lixeira_service, "storage_list_files", lambda prefix: [])\n30:     monkeypatch.setattr(\n31:         lixeira_service,
```

- `tests/test_modules_aliases.py`:41

```text
41:     from src.modules.uploads import service as mod\n42:     from src.core.services import upload_service as legacy\n43: \n44:     assert mod.upload_folder_to_supabase is legacy.upload_folder_to_supabase\n45: \n46: \n47: def test_forms_service_aliases() -> None:
```

- `uploader_supabase.py`:1

```text
1: # -*- coding: utf-8 -*-\n2: """Helpers para o fluxo de upload de documentos ao Supabase."""\n3: \n4: from __future__ import annotations\n5:
```


### Treeview | Listbox | messagebox

#### Termo `Treeview`

- `src/features/cashflow/ui.py`:101

```text
101:         ttk.Button(top, text="Excluir", command=self.delete).pack(side="right", padx=4)\n102: \n103:         # --- grade ---\n104:         self.tree = ttk.Treeview(\n105:             self,\n106:             columns=("date", "type", "category", "description", "amount", "account"),\n107:             show="headings",
```

- `src/modules/auditoria/views/components.py`:71

```text
71: \n72: \n73: class AuditoriaListPanel(ttk.Labelframe):\n74:     """List panel containing the treeview and action buttons."""\n75: \n76:     def __init__(\n77:         self,
```

- `src/modules/auditoria/views/dialogs.py`:159

```text
159:         tree_frame.pack(fill="both", expand=True)\n160: \n161:         height = min(len(sample_names[:20]), 10)\n162:         self.tree_sample = ttk.Treeview(tree_frame, columns=("arquivo",), show="tree headings", height=height, selectmode="none")\n163:         self.tree_sample.heading("#0", text="")\n164:         self.tree_sample.heading("arquivo", text="Arquivo", anchor="w")\n165:         self.tree_sample.column("#0", width=0, stretch=False)
```

- `src/modules/auditoria/views/main_frame.py`:331

```text
331:         self._apply_filter()\n332: \n333:     def _load_auditorias(self) -> None:\n334:         """Carrega lista de auditorias via viewmodel e atualiza a treeview."""\n335:         if not self._controller.is_online():\n336:             return\n337:
```

- `src/modules/cashflow/views/fluxo_caixa_frame.py`:87

```text
87:         ttk.Button(top, text="Excluir", command=self.delete).pack(side="right", padx=4)\n88: \n89:         # --- grade ---\n90:         self.tree = ttk.Treeview(\n91:             self,\n92:             columns=("date", "type", "category", "description", "amount", "account"),\n93:             show="headings",
```

- `src/modules/clientes/forms/client_picker.py`:104

```text
104:         self.search_button = tb.Button(search_frame, text="Buscar", command=self._do_search, bootstyle="primary")\n105:         self.search_button.pack(side="left", padx=5)\n106: \n107:         # Treeview\n108:         tree_frame = tb.Frame(main)\n109:         tree_frame.pack(fill="both", expand=True, pady=(0, 10), padx=(10, 10))\n110:
```

- `src/modules/clientes/viewmodel.py`:35

```text
35: class ClientesViewModel:\n36:     """\n37:     Centraliza carregamento, filtros e ordenação da lista de clientes.\n38:     Mantém cache local e expõe linhas prontas para a Treeview.\n39:     """\n40: \n41:     def __init__(
```

- `src/modules/clientes/views/main_screen.py`:24

```text
24: \n25: from infra.supabase_client import get_supabase_state\n26: \n27: from src.ui.components import create_clients_treeview\n28: \n29: from src.modules.clientes.components.helpers import (\n30:     _build_status_menu,
```

- `src/modules/lixeira/views/lixeira.py`:68

```text
68:         pass\n69: \n70: \n71: # ---------------- janela principal da Lixeira (com Treeview) ----------------\n72: def abrir_lixeira(parent, app=None):\n73:     """Abre a Lixeira em modo singleton: se já estiver aberta, só foca e recarrega."""\n74:     global _OPEN_WINDOW
```

- `src/modules/passwords/views/passwords_screen.py`:279

```text
279:         table_frame.pack(fill="both", expand=True)\n280: \n281:         columns = ("cliente", "servico", "usuario", "senha", "anotacoes")\n282:         self.tree = ttk.Treeview(\n283:             table_frame,\n284:             columns=columns,\n285:             show="headings",
```

- `src/modules/uploads/views/file_list.py`:6

```text
6: \n7: \n8: class FileList(ttk.Frame):\n9:     """Treeview que exibe arquivos e delega acoes para callbacks."""\n10: \n11:     def __init__(\n12:         self,
```

- `src/ui/components/__init__.py`:1

```text
1: # -*- coding: utf-8 -*-\n2: from .buttons import FooterButtons, create_footer_buttons, toolbar_button\n3: from .inputs import SearchControls, create_search_controls, labeled_entry\n4: from .lists import create_clients_treeview\n5: from .misc import (\n6:     MenuComponents,\n7:     StatusIndicators,
```

- `src/ui/components/lists.py`:24

```text
24: logger = logging.getLogger(__name__)\n25: log = logger\n26: \n27: __all__ = ["create_clients_treeview"]\n28: \n29: \n30: def create_clients_treeview(
```

- `src/ui/components/misc.py`:158

```text
158: \n159: \n160: def draw_whatsapp_overlays(tree: tk.Widget, column: str, size: int = 15) -> None:\n161:     """Desenha ícones do WhatsApp sobre a coluna especificada em um Treeview."""\n162:     if not hasattr(tree, "_wa_overlays"):\n163:         tree._wa_overlays = []\n164:
```

- `src/ui/dialogs/storage_uploader.py`:38

```text
38:         self.ent_prefix = ttk.Entry(frm, width=42)\n39:         self.ent_prefix.grid(row=1, column=1, sticky="we", padx=(6, 0), pady=(8, 0))\n40: \n41:         self.tree = ttk.Treeview(frm, columns=("name",), show="tree", height=12)\n42:         self.tree.grid(row=2, column=0, columnspan=2, sticky="nsew", pady=(8, 0))\n43:         yscroll = ttk.Scrollbar(frm, orient="vertical", command=self.tree.yview)\n44:         self.tree.configure(yscroll=yscroll.set)
```

- `src/ui/files_browser.py`:192

```text
192:     # ConfiguraÃ§Ã£o de grid para layout estÃ¡vel\n193:     docs_window.minsize(980, 620)\n194:     docs_window.columnconfigure(0, weight=1)\n195:     docs_window.rowconfigure(1, weight=1)  # linha da Treeview/scroll\n196: \n197:     header = ttk.Frame(docs_window)\n198:     header.grid(row=0, column=0, sticky="ew")
```

- `src/ui/subpastas_dialog.py`:16

```text
16: \n17: class SubpastaDialog(tk.Toplevel):\n18:     """\n19:     Diálogo mínimo que lista objetos de um prefixo do Storage usando Treeview.\n20: \n21:     Permite ao usuário escolher uma subpasta ou criar uma nova.\n22:     """
```

#### Termo `Listbox`

- `src/ui/widgets/autocomplete_entry.py`:31

```text
31:         self.on_pick: Optional[Callable[[Dict[str, Any]], None]] = None\n32: \n33:         self._dropdown: Optional[tk.Toplevel] = None\n34:         self._listbox: Optional[tk.Listbox] = None\n35:         self._suggestions: List[Dict[str, Any]] = []\n36:         self._debounce_id: Optional[str] = None\n37:         self._debounce_ms = 300
```

#### Termo `messagebox`

- `src/app_core.py`:6

```text
6: import importlib\n7: import logging\n8: import os\n9: from tkinter import messagebox\n10: from typing import Any, Sequence\n11: \n12: from src.config.paths import CLOUD_ONLY
```

- `src/core/services/lixeira_service.py`:5

```text
5: import os\n6: import tkinter as tk\n7: from tempfile import NamedTemporaryFile\n8: from tkinter import messagebox\n9: from typing import Iterable, List, Tuple\n10: \n11: from adapters.storage.api import delete_file as storage_delete_file
```

- `src/features/cashflow/dialogs.py`:1

```text
1: from __future__ import annotations\n2: \n3: from tkinter import Toplevel, StringVar, DoubleVar, ttk, messagebox\n4: from datetime import date\n5: from typing import Optional, Dict, Any\n6:
```

- `src/features/cashflow/ui.py`:3

```text
3: from __future__ import annotations\n4: \n5: import tkinter as tk\n6: from tkinter import Toplevel, StringVar, ttk, messagebox\n7: from datetime import date, timedelta\n8: from typing import Optional\n9:
```

- `src/modules/auditoria/views/main_frame.py`:5

```text
5: import re\n6: import tkinter as tk\n7: import unicodedata\n8: from tkinter import messagebox, ttk\n9: from typing import Callable, Literal, Optional\n10: \n11: from helpers.formatters import fmt_datetime_br
```

- `src/modules/auditoria/views/storage_actions.py`:2

```text
2: \n3: from __future__ import annotations\n4: \n5: from tkinter import messagebox\n6: from typing import TYPE_CHECKING\n7: \n8: from src.modules.auditoria.service import AuditoriaServiceError
```

- `src/modules/auditoria/views/upload_flow.py`:6

```text
6: import time\n7: from dataclasses import dataclass\n8: from pathlib import Path\n9: from tkinter import messagebox\n10: from typing import TYPE_CHECKING, Any, Callable\n11: \n12: from src.modules.auditoria.service import ArchiveError, AuditoriaServiceError
```

- `src/modules/cashflow/views/fluxo_caixa_frame.py`:2

```text
2: \n3: import tkinter as tk\n4: from datetime import date, timedelta\n5: from tkinter import messagebox, ttk\n6: from typing import Any, Optional\n7: \n8: import ttkbootstrap as tb
```

- `src/modules/clientes/forms/client_form.py`:6

```text
6: \n7: import logging\n8: import tkinter as tk\n9: from tkinter import messagebox, ttk\n10: from typing import Any, Optional\n11: \n12: from src.modules.clientes.components.helpers import STATUS_CHOICES, STATUS_PREFIX_RE
```

- `src/modules/clientes/forms/client_picker.py`:8

```text
8: import logging\n9: import re\n10: import tkinter as tk\n11: from tkinter import messagebox, ttk\n12: from typing import Any, Dict, Optional\n13: \n14: import ttkbootstrap as tb
```

- `src/modules/clientes/forms/pipeline.py`:12

```text
12: import tkinter as tk\n13: from dataclasses import dataclass, field\n14: from pathlib import Path\n15: from tkinter import filedialog, messagebox, ttk\n16: from typing import TYPE_CHECKING, Any, Dict, List, Mapping, Optional, Tuple\n17: \n18: from adapters.storage.api import delete_file as storage_delete_file
```

- `src/modules/clientes/views/main_screen.py`:12

```text
12: \n13: import webbrowser\n14: \n15: from tkinter import messagebox, ttk\n16: \n17: from typing import Any, Callable, Dict, List, Optional, Sequence, Tuple\n18:
```

- `src/modules/clientes/views/pick_mode.py`:2

```text
2: \n3: from dataclasses import dataclass\n4: import re\n5: from tkinter import messagebox\n6: from typing import Callable, Optional, TYPE_CHECKING\n7: \n8: import logging
```

- `src/modules/hub/actions.py`:7

```text
7: import threading\n8: \n9: \n10: from tkinter import messagebox\n11: \n12: \n13: from src.core.logger import get_logger
```

- `src/modules/hub/controller.py`:8

```text
8: \n9: import threading\n10: \n11: from tkinter import messagebox\n12: \n13: from typing import Any, Dict, List\n14:
```

- `src/modules/hub/views/hub_screen.py`:6

```text
6: import threading\n7: import time\n8: from datetime import datetime, timezone\n9: from tkinter import messagebox\n10: from typing import Any, Callable, Dict, List, Optional\n11: \n12: import ttkbootstrap as tb
```

- `src/modules/lixeira/views/lixeira.py`:8

```text
8: import os\n9: import threading\n10: import tkinter as tk\n11: from tkinter import messagebox as tkmsg\n12: from tkinter import ttk\n13: from typing import Iterable\n14:
```

- `src/modules/main_window/controller.py`:1

```text
1: from __future__ import annotations\n2: \n3: import logging\n4: from tkinter import messagebox\n5: from typing import Any, Optional\n6: \n7: from src.modules.notas import HubFrame
```

- `src/modules/main_window/views/main_window.py`:9

```text
9: import sys\n10: import threading\n11: import tkinter as tk\n12: from tkinter import messagebox, ttk\n13: from typing import Any, Optional\n14: \n15: import ttkbootstrap as tb
```

- `src/modules/passwords/views/passwords_screen.py`:5

```text
5: \n6: import logging\n7: import tkinter as tk\n8: from tkinter import messagebox, ttk\n9: from typing import Any, Callable, Optional\n10: \n11: import ttkbootstrap as tb
```

- `src/modules/pdf_preview/views/main_window.py`:523

```text
523: \n524:         try:\n525:             dst = save_image(pil, ctx)\n526:             from tkinter import messagebox\n527: \n528:             messagebox.showinfo("Baixar imagem", f"Salvo em:\\n{dst}", parent=self)\n529:         except Exception:
```

- `src/modules/uploads/views/browser.py`:5

```text
5: import logging\n6: import tkinter as tk\n7: from concurrent.futures import ThreadPoolExecutor\n8: from tkinter import filedialog, messagebox, ttk\n9: from typing import Any\n10: \n11: from src.modules.uploads.components.helpers import client_prefix_for_id, format_cnpj_for_display, get_clients_bucket, strip_cnpj_from_razao
```

- `src/shared/storage_ui_bridge.py`:71

```text
71:     um aviso informando a falha.\n72:     """\n73:     if not sb:\n74:         from tkinter import messagebox\n75: \n76:         messagebox.showwarning("Arquivos", "Modo offline.")\n77:         return
```

- `src/ui/dialogs/storage_uploader.py`:10

```text
10: import posixpath\n11: import threading\n12: import tkinter as tk\n13: from tkinter import filedialog, messagebox, ttk\n14: from typing import List, Optional, Tuple\n15: \n16: log = logging.getLogger(__name__)
```

- `src/ui/dialogs/upload_progress.py`:3

```text
3: \n4: import threading\n5: import tkinter as tk\n6: from tkinter import messagebox, ttk\n7: from typing import Any\n8: \n9: from src.modules.uploads.service import upload_folder_to_supabase
```

- `src/ui/files_browser.py`:5

```text
5: import tkinter as tk\n6: from concurrent.futures import ThreadPoolExecutor\n7: from pathlib import Path, PurePosixPath\n8: from tkinter import filedialog, messagebox, ttk\n9: from typing import Any, Callable, Dict, Optional, Tuple\n10: \n11: from src.modules.pdf_preview import open_pdf_viewer
```

- `src/ui/forms/actions.py`:6

```text
6: import os\n7: import tkinter as tk\n8: from pathlib import Path\n9: from tkinter import filedialog, messagebox, ttk\n10: from typing import Optional\n11: \n12: from dotenv import load_dotenv
```

- `src/ui/login/login.py`:6

```text
6: import tkinter as tk\n7: \n8: import ttkbootstrap as tb\n9: from ttkbootstrap.dialogs import Messagebox\n10: \n11: from src.core import session\n12: from src.core.auth import authenticate_user, ensure_users_db, validate_credentials
```

- `src/ui/login_dialog.py`:3

```text
3: import os\n4: import re\n5: import tkinter as tk\n6: from tkinter import messagebox, ttk\n7: \n8: from data.auth_bootstrap import _get_access_token\n9: from infra.healthcheck import healthcheck  # <-- ADICIONADO: health check pós-login
```

- `src/ui/menu_bar.py`:2

```text
2: from __future__ import annotations\n3: \n4: import tkinter as tk\n5: from tkinter import messagebox\n6: from typing import Callable, Iterable, Optional\n7: \n8:
```

- `src/ui/subpastas_dialog.py`:8

```text
8: \n9: import logging\n10: import tkinter as tk\n11: from tkinter import messagebox, ttk\n12: from typing import Optional\n13: \n14: logger = logging.getLogger(__name__)
```

- `src/utils/errors.py`:43

```text
43:             try:\n44:                 # Only import tkinter if we need it (avoid import in tests)\n45:                 import tkinter as tk\n46:                 from tkinter import messagebox\n47: \n48:                 # Check if we can show GUI (main loop exists)\n49:                 try:
```

- `src/utils/helpers/cloud_guardrails.py`:5

```text
5: \n6: from __future__ import annotations\n7: \n8: from tkinter import messagebox\n9: \n10: from src.config.paths import CLOUD_ONLY\n11:
```

- `src/utils/network.py`:114

```text
114:     if os.getenv("RC_NO_GUI_ERRORS") != "1":\n115:         try:\n116:             import tkinter as tk\n117:             from tkinter import messagebox\n118: \n119:             # Create minimal root if needed\n120:             root = tk.Tk()
```

- `tests/test_clientes_integration.py`:71

```text
71:     monkeypatch.setattr(clientes_pipeline, "_ask_subpasta", lambda parent: "SUBPASTA")\n72:     monkeypatch.setattr(clientes_pipeline, "CLOUD_ONLY", True, raising=False)\n73: \n74:     monkeypatch.setattr(clientes_pipeline.messagebox, "showwarning", lambda *a, **k: None)\n75:     monkeypatch.setattr(clientes_pipeline.messagebox, "showinfo", lambda *a, **k: None)\n76:     monkeypatch.setattr(clientes_pipeline.messagebox, "showerror", lambda *a, **k: None)\n77:     monkeypatch.setattr(clientes_pipeline.filedialog, "askdirectory", lambda **_k: "")
```

- `tests/test_lixeira_service.py`:80

```text
80:         "exec_postgrest",\n81:         lambda *a, **k: updates.append((a, k)),\n82:     )\n83:     monkeypatch.setattr(lixeira_service.messagebox, "showerror", lambda *a, **k: None)\n84: \n85:     ok, errs = lixeira_service.restore_clients([10, 11], parent=None)\n86:
```

- `uploader_supabase.py`:9

```text
9: from typing import List, Optional, Sequence, Tuple, cast\n10: \n11: import tkinter as tk\n12: from tkinter import filedialog, messagebox, ttk\n13: \n14: import ttkbootstrap as tb\n15:
```


## 4. Fun??es p?blicas e fluxo (clientes)

### `src/core/services/clientes_service.py`
- `checar_duplicatas_info(numero: str, cnpj: str, nome: str, razao: str, *, exclude_id: int | None = None) -> dict[str, object]`
  - Normaliza CNPJ/raz?o via `normalize_cnpj_norm` e `normalize_text`, consulta `find_cliente_by_cnpj_norm` e `list_clientes` para montar `cnpj_conflict`, `razao_conflicts`, `numero_conflicts`, `cnpj_norm` e `razao_norm`.
  - Usada por `src/modules/clientes/service.checar_duplicatas_para_form`, que abastece `form_cliente` e o pipeline de envio antes de confirmar salvamento.
- `salvar_cliente(row, valores: dict) -> tuple[int, str]`
  - Usa `_normalize_payload` para padronizar campos vindos da UI, exige pelo menos um identificador (raz?o/CNPJ/nome/WhatsApp) e bloqueia duplicidade de CNPJ consultando `find_cliente_by_cnpj_norm`.
  - Decide entre `update_cliente` e `insert_cliente` (ambos em `src/core/db_manager`), registra auditoria (`log_client_action`) e cria/migra pasta local via `_pasta_do_cliente`/`_migrar_pasta_se_preciso`. Retorna `(id_gerado, pasta_local)`.
  - Consumido por `src/modules/clientes/service.salvar_cliente_a_partir_do_form` (invocado pelo formul?rio) e por `src/modules/clientes/forms/pipeline.prepare_payload` durante `salvar_e_upload_docs`.

### `src/ui/forms/actions.py`
- `preencher_via_pasta(ents: dict) -> None`
  - Abre `filedialog`, usa `list_and_classify_pdfs`/`find_cartao_cnpj_pdf`/`read_pdf_text` + `extract_company_fields` para detectar CNPJ/Raz?o no Cart?o-CNPJ e preenche widgets do formul?rio; alerta via `messagebox` quando nada ? encontrado.
- `salvar_e_enviar_para_supabase(self, row, ents, win=None)`
  - Verifica conectividade Supabase (`is_really_online`/`get_supabase_state`), abre `_select_pdfs_dialog`, transforma PDFs em itens (`build_items_from_files`) e chama `upload_files_to_supabase` (que usa `SupabaseStorageAdapter`). Usado quando a UI precisa apenas subir documentos para um cliente j? salvo.
- `salvar_e_upload_docs(self, row, ents: dict, arquivos_selecionados: list | None, win=None)`
  - Encaminha os argumentos para o pipeline herdado (`validate_inputs -> prepare_payload -> perform_uploads -> finalize_state`, reexportado de `src/modules/clientes/forms/pipeline`).
  - `prepare_payload` chama `clientes_service.salvar_cliente`, persiste o cliente e preenche o contexto (id, pasta, org_id). `perform_uploads` usa `SupabaseStorageAdapter`, `storage_upload_file` e atualiza a UI via `self.after`/`self.carregar`.
  - ? chamado por `src/modules/clientes/forms/client_form.form_cliente` quando o usu?rio clica em ?Salvar + Enviar?.

### `src/ui/forms/forms.py`
- `form_cliente(*args, **kwargs)`
  - Shim que redireciona para `src/modules/clientes/forms/form_cliente`. Esse formul?rio concreto executa `checar_duplicatas_para_form` (que usa `checar_duplicatas_info`) e salva com `salvar_cliente_a_partir_do_form`, que valida CNPJ via `find_cliente_by_cnpj_norm` antes de delegar para `clientes_service.salvar_cliente`.

**Fluxo observado (quem chama quem):** UI `form_cliente` (module `src/modules/clientes/forms/client_form.py`) ? servi?o do m?dulo (`src/modules/clientes/service`) ? core (`src/core/services/clientes_service`) ? `src/core/db_manager`/Supabase. A??es de upload (`salvar_e_upload_docs`) seguem: formul?rio ? `ui/forms/actions` ? pipeline (`src/modules/clientes/forms/pipeline`) ? `clientes_service.salvar_cliente` ? storage Supabase (`adapters.storage.*`).
