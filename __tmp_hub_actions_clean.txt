"""Event handlers and UI actions for the Hub screen."""


from __future__ import annotations


import threading


from tkinter import messagebox


from src.core.logger import get_logger


from src.modules.notas import service as notes_service


from src.modules.hub.controller import (


    refresh_notes_async,


)


logger = get_logger("gui.hub_screen")


log = logger


def on_show(screen) -> None:


    """


    Chamado sempre que a tela do Hub fica vis├¡vel (navega├º├úo de volta).


    Garante renderiza├º├úo imediata dos dados em cache e mant├®m live-sync ativo.


    """


    try:


        screen._start_live_sync()


    except Exception as e:


        log.warning("Erro ao iniciar live-sync no on_show: %s", e)


    try:


        is_empty = screen.notes_history.index("end-1c") == "1.0"


    except Exception:


        is_empty = True


    if is_empty and getattr(screen, "_notes_last_data", None):


        try:


            screen.render_notes(screen._notes_last_data, force=True)


        except Exception as e:


            log.warning("Erro ao renderizar notas no on_show: %s", e)


    try:


        screen._author_names_cache = {}


        screen._email_prefix_map = {}


        screen._names_cache_loaded = False


        screen._last_org_for_names = None


        screen._refresh_author_names_cache_async(force=True)


    except Exception as e:


        log.warning("Erro ao atualizar cache de nomes no on_show: %s", e)


def on_add_note_clicked(screen) -> None:


    """Handler do bot├úo 'Adicionar' anota├º├úo."""


    text = screen.new_note.get("1.0", "end").strip()


    if not text:


        return


    if not screen._auth_ready():


        messagebox.showerror(


            "N├úo autenticado",


            "Voc├¬ precisa estar autenticado para adicionar uma anota├º├úo.",


            parent=screen,


        )


        return


    app = screen._get_app()


    if not app or not screen._is_online(app):


        messagebox.showerror(


            "Sem conex├úo",


            "N├úo ├® poss├¡vel adicionar anota├º├Áes sem conex├úo com a internet.",


            parent=screen,


        )


        return


    org_id = screen._get_org_id_safe()


    user_email = screen._get_email_safe()


    if not org_id or not user_email:


        messagebox.showerror(


            "Erro",


            "Sess├úo incompleta (organiza├º├úo/usu├írio n├úo identificados). Tente novamente ap├│s o login.",


            parent=screen,


        )


        return


    screen.btn_add_note.configure(state="disabled")


    def _work():


        ok = True


        error_msg = ""


        table_missing = False


        auth_error = False


        transient_error = False


        try:


            notes_service.add_note(org_id, user_email, text)


        except notes_service.NotesTransientError:


            transient_error = True


            error_msg = "Conex├úo inst├ível, tentando novamenteÔÇª"


            log.debug("HubScreen: Erro transit├│rio ao adicionar nota")


        except notes_service.NotesTableMissingError as exc:


            table_missing = True


            error_msg = "Tabela de anota├º├Áes n├úo encontrada no Supabase."


            log.warning("HubScreen: %s", exc)


            def _mark_table_missing():


                screen._notes_table_missing = True


                screen._notes_table_missing_notified = True


            try:


                screen.after(0, _mark_table_missing)


            except Exception:


                pass


        except notes_service.NotesAuthError as exc:


            auth_error = True


            error_msg = str(exc)


            log.warning("HubScreen: %s", exc)


        except Exception as exc:


            ok = False


            error_msg = str(exc)


            log.warning("HubScreen: Falha ao adicionar nota: %s", exc)


        def _ui():


            try:


                screen.btn_add_note.configure(state="normal")


            except Exception:


                pass


            if transient_error and not table_missing and not auth_error:


                try:


                    messagebox.showwarning(


                        "Conex├úo Inst├ível",


                        "A nota ser├í salva assim que a conex├úo estabilizar.",


                        parent=screen,


                    )


                except Exception:


                    pass


            elif table_missing:


                try:


                    messagebox.showerror(


                        "Anotações Indisponíveis",


                        "Bloco de anota├º├Áes indispon├¡vel:\n\n"


                        "A tabela 'rc_notes' n├úo existe no Supabase.\n"


                        "Execute a migra├º├úo em: migrations/rc_notes_migration.sql\n\n"


                        "Tentaremos novamente em 60 segundos.",


                        parent=screen,


                    )


                except Exception:


                    pass


            elif auth_error:


                try:


                    messagebox.showerror(


                        "Sem Permiss├úo",


                        f"Sem permiss├úo para anotar nesta organiza├º├úo.\nVerifique seu cadastro em 'profiles'.\n\nDetalhes: {error_msg}",


                        parent=screen,


                    )


                except Exception:


                    pass


            elif ok:


                try:


                    screen.new_note.delete("1.0", "end")


                except Exception:


                    pass


                refresh_notes_async(screen, force=True)


                screen._refresh_author_names_cache_async(force=False)


                try:


                    messagebox.showinfo(


                        "Sucesso",


                        "Anotação adicionada com sucesso!",


                        parent=screen,


                    )


                except Exception:


                    pass


            else:


                try:


                    messagebox.showerror(


                        "Erro",


                        f"Falha ao adicionar anota├º├úo: {error_msg}",


                        parent=screen,


                    )


                except Exception:


                    pass


        try:


            screen.after(0, _ui)


        except Exception:


            pass


    threading.Thread(target=_work, daemon=True).start()
